name: Ansible CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core ansible-lint
          ansible-galaxy collection install -r requirements.yml

      - name: Run ansible-lint on orchestrator playbook
        run: ansible-lint --offline src/playbooks/data_product.yml

  molecule:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Molecule dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core molecule[docker]
          ansible-galaxy collection install -r requirements.yml

      - name: Execute Molecule scenario
        run: molecule test -s data_product

  packer-smoke:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Packer
        uses: hashicorp/setup-packer@v2
        with:
          packer_version: "1.10.0"

      - name: Initialize Packer plugins
        working-directory: packer
        run: packer init template.pkr.hcl

      - name: Run smoke test build
        working-directory: packer
        run: packer build -var playbook_file=playbooks/smoke_localhost.yml template.pkr.hcl
