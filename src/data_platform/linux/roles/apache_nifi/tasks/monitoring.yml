---
- name: Ensure NiFi monitoring directory exists
  become: true
  ansible.builtin.file:
    path: "{{ apache_nifi_conf_dir }}/monitoring"
    state: directory
    owner: "{{ apache_nifi_user }}"
    group: "{{ apache_nifi_group }}"
    mode: '0750'
  tags: [nifi, monitoring, prometheus]

- name: Download Prometheus JMX exporter for NiFi
  become: true
  ansible.builtin.get_url:
    url: >-
      https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/
      {{ apache_nifi_prometheus_jmx_exporter_version }}/
      jmx_prometheus_javaagent-{{ apache_nifi_prometheus_jmx_exporter_version }}.jar
    dest: "{{ apache_nifi_home }}/lib/jmx_prometheus_javaagent.jar"
    mode: '0644'
  notify: Restart NiFi
  tags: [nifi, monitoring, prometheus]

- name: Deploy Prometheus JMX exporter configuration
  become: true
  ansible.builtin.template:
    src: jmx_prometheus_config.yml.j2
    dest: "{{ apache_nifi_prometheus_jmx_config_path }}"
    owner: "{{ apache_nifi_user }}"
    group: "{{ apache_nifi_group }}"
    mode: '0640'
  notify: Restart NiFi
  tags: [nifi, monitoring, prometheus]
