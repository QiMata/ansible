---
- name: Ensure Java is present
  become: true
  ansible.builtin.apt:
    name: openjdk-11-jdk
    state: present
  tags: [nifi, java]

- name: Create nifi group
  become: true
  ansible.builtin.group:
    name: "{{ nifi_group }}"
    state: present
  tags: [nifi, users]

- name: Create nifi user
  become: true
  ansible.builtin.user:
    name: "{{ nifi_user }}"
    group: "{{ nifi_group }}"
    home: "{{ nifi_home }}"
    shell: /usr/sbin/nologin
    system: true
  tags: [nifi, users]

- name: Add NiFi APT repository
  become: true
  ansible.builtin.apt_repository:
    repo: "{{ nifi_apt_repo }}"
    state: present
  when: nifi_use_apt_repo
  tags: [nifi, repo]

- name: Install/upgrade NiFi via package
  become: true
  ansible.builtin.apt:
    name: nifi
    state: present
    update_cache: true
  when: nifi_install_method == "package"
  tags: [nifi, install]

- name: Download NiFi tarball
  become: true
  ansible.builtin.get_url:
    url: "https://archive.apache.org/dist/nifi/{{ nifi_version }}/nifi-{{ nifi_version }}-bin.tar.gz"
    dest: "/tmp/nifi-{{ nifi_version }}.tar.gz"
    mode: '0644'
  when: nifi_install_method == "tarball"
  tags: [nifi, install]

- name: Extract NiFi tarball
  become: true
  ansible.builtin.unarchive:
    src: "/tmp/nifi-{{ nifi_version }}.tar.gz"
    dest: "{{ nifi_home }}"
    remote_src: true
    creates: "{{ nifi_home }}/bin/nifi.sh"
  when: nifi_install_method == "tarball"
  tags: [nifi, install]

- name: Ensure correct ownership
  become: true
  ansible.builtin.file:
    path: "{{ nifi_home }}"
    state: directory
    recurse: true
    owner: "{{ nifi_user }}"
    group: "{{ nifi_group }}"
  tags: [nifi, permissions]
