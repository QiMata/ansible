# Ansible Role: OpenLDAP Setup

**Table of Contents**

* [Overview](#overview)
* [Supported Operating Systems/Platforms](#supported-operating-systemsplatforms)
* [Role Variables](#role-variables)
* [Tags](#tags)
* [Dependencies](#dependencies)
* [Example Playbook](#example-playbook)
* [Testing Instructions](#testing-instructions)
* [Known Issues and Gotchas](#known-issues-and-gotchas)
* [Security Implications](#security-implications)
* [Cross-Referencing](#cross-referencing)

## Overview

This Ansible role installs and configures an **OpenLDAP directory server** (slapd) on target hosts. It handles the installation of required packages (OpenLDAP server and utilities) and applies initial configuration for the LDAP server to function. Specifically, the role will:

* **Install OpenLDAP** (slapd) and related packages (e.g. client utilities, Python LDAP library) via the system package manager.
* **Initialize the LDAP Directory:** Set the directory's *suffix/base DN* based on a configurable domain name (e.g. `dc=example,dc=com`), and configure the *root DN* (administrative user) and *root password* for the directory.
* **Configure Access Controls:** Define default ACL rules (olcAccess) on the LDAP database to govern who can read or modify data. By default, the role restricts password attribute access and permits read access to other data (see **Security Implications**).
* **Manage Service State:** Ensure the slapd service is enabled and running after installation.
* **Optional TLS Support:** Support running LDAP over TLS/SSL (LDAPS) on port 636 if enabled. When TLS is enabled, the role adjusts the slapd service to listen on LDAPS instead of plain LDAP. (Note: Additional steps for certificate configuration are required – see **Known Issues** and **Security Implications**.)
* **Replication (Advanced):** The role includes tasks for a **multi-master replication** setup between two LDAP servers. These tasks set up syncrepl provider statements and mirror mode on the LDAP config, though they are applied unconditionally (see **Known Issues** for guidance on using or disabling this feature).

Overall, this role automates the basic setup of an OpenLDAP server, providing an idempotent way to get a running LDAP service with a defined directory base, admin account, and baseline security settings. It is intended for deploying new LDAP servers and can be used in conjunction with additional roles (for populating LDAP content, enabling replication, etc.) to build a complete directory service.

## Supported Operating Systems/Platforms

This role is designed for **Debian-based Linux distributions**. It has been developed and tested on:

* **Ubuntu** – e.g. 18.04 Bionic, 20.04 Focal, 22.04 Jammy (LTS releases)
* **Debian** – e.g. 10 (Buster), 11 (Bullseye) and likely newer versions

> **Note:** The role uses the `apt` package manager and Debian/Ubuntu-specific package names (like **slapd**, **ldap-utils**, etc.). It also includes tasks specific to Ubuntu versions (for example, installing `python-selinux` on Ubuntu < 20). It will **not work on RHEL/CentOS or other non-Debian systems without modification**. If you need to use it on those systems, you would have to replace the package installation and service management steps with the appropriate equivalents (e.g. use `yum`/`dnf` and install `openldap-servers` on Red Hat systems). Ensure your target hosts are running a supported Debian/Ubuntu OS before using this role.

## Role Variables

Below is a list of the variables configurable for this role, along with their default values (defined in **`defaults/main.yml`**) and a description of their purpose. **All variables are optional** except where noted, but you will typically want to override at least a few (such as the domain and admin password). Variables marked as **(required)** should be set by the user as the defaults are placeholders.

<!-- markdownlint-disable MD033 -->

<details>
<summary>Role Variables (defaults)</summary>

| Variable                            | Default Value                                                                                   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ----------------------------------- | ----------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`openldap_server_domain`**        | `"example.net"`                                                                                 | **Base domain name** for the LDAP directory. This is used to construct the base DN of the directory. For example, if set to `"example.net"`, the directory suffix will be `dc=example,dc=net`. Typically you should set this to your organization’s domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **`_basedn`**                       | `"dc={{ openldap_server_domain.split('.')[0] }},dc={{ openldap_server_domain.split('.')[1] }}"` | **Base DN (suffix)** of the LDAP directory, constructed from the domain. By default this takes the first two labels of `openldap_server_domain`. For instance, with `openldap_server_domain: example.net`, `_basedn` becomes `dc=example,dc=net`. If your domain has more than two components (e.g. `sales.example.com`), you may need to override `_basedn` to include all parts (e.g. `dc=sales,dc=example,dc=com`).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **`openldap_server_rootdn`**        | `"cn=Manager,{{ _basedn }}"`                                                                    | **Root DN** for the LDAP directory (administrative user’s distinguished name). This is the name of the LDAP admin account. By default it is set to *“Manager”* under the base DN (e.g. `cn=Manager,dc=example,dc=net`). You can change the “Manager” to another name if desired (e.g. `cn=Admin,{{ _basedn }}`).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **`openldap_server_rootpw`**        | `""` (empty string)                                                                             | **Root DN password** for the LDAP admin. **(Required)** – by default no password is set in the role. You **must override this** with a secure value. It can be provided in plain-text or as a pre-hashed value. For security, using a hashed password (SSHA) is recommended (see **Security Implications**). This password will be set as the LDAP **olcRootPW** for the database.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **`openldap_server_app_path`**      | `"/etc/ldap"`                                                                                   | Base path for OpenLDAP configuration and data files. This role uses it mainly for locating SSL certificate files. The default is `/etc/ldap` (the standard config directory on Debian/Ubuntu). Under this path, the role expects a `certs/` subdirectory for certificates if TLS is enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **`openldap_server_user`**          | `"openldap"`                                                                                    | System user account under which the slapd service runs. On Debian/Ubuntu, the package installation creates an `openldap` user. The role assumes this user owns the LDAP files and processes. It also ensures this user is present and adds it to the `root` group (to allow reading root-owned cert files, if any). Generally you should not change this unless you have a custom install.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **`openldap_server_enable_tls`**    | `false`                                                                                         | Whether to **enable TLS/SSL (LDAPS)** for the LDAP server. If `false` (default), the LDAP service will listen on plaintext LDAP (port 389) only. If set to `true`, the role will configure slapd to listen on LDAPS (port 636) instead, and you should provide certificate/key files (or enable generation) as described below. **Note:** Additional manual configuration is needed to actually use TLS (see `openldap_server_ssl_cert`/`key` and notes in **Known Issues**).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **`openldap_server_ssl_cert`**      | `"{{ openldap_server_app_path }}/certs/cert.crt"`                                               | Filesystem path to the **SSL/TLS certificate** file for the LDAP server. Used only if TLS is enabled. By default, it points to `certs/cert.crt` under the LDAP config path (e.g. `/etc/ldap/certs/cert.crt`). You should place your server’s public certificate at this location (or override this path). This can be a self-signed cert or one from a CA, but ensure the clients trust it if using a custom CA.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **`openldap_server_ssl_key`**       | `"{{ openldap_server_app_path }}/certs/my.key"`                                                 | Filesystem path to the **SSL/TLS private key** for the LDAP server. Used only if TLS is enabled. Default is `/etc/ldap/certs/my.key`. This should be the private key corresponding to the above certificate. The `openldap` user will need read access to this file. Make sure to secure this key (permissions, etc.) because it grants access to your encrypted LDAP traffic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **`openldap_server_generate_cert`** | `false`                                                                                         | Whether to **auto-generate a self-signed certificate** for the LDAP server. If `true`, the role is intended to generate a new self-signed certificate and key (using the details in `openldap_server_ssl`) and place them in the paths above. By default this is `false` (no auto-generation). *Note:* The current implementation of this role does not yet include tasks to generate the cert (even if enabled), so this is more of a placeholder for future use or for custom extension (see **Known Issues**).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`openldap_server_ssl`**           | `{}` (empty dictionary)                                                                         | Parameters for self-signed certificate generation. *(Used only if `openldap_server_generate_cert` is `true`.)* This is a dictionary that can define fields for the certificate subject. For example: <br> `country`, `state`, `location` (city), `organization`, and potentially `common_name`. By default, this is not set in the role (an example is shown in the defaults). If you enable cert generation, you should provide appropriate values (e.g. country code, organization name, etc.).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`openldap_olcAccess`**            | *Two default rules* (see description)                                                           | List of **access control rules** (ACLs) to apply to the LDAP database (this populates the `olcAccess` attribute in the config database). **By default, two rules are defined**: <br>1. **Protect passwords:** `to attrs=userPassword,shadowLastChange` – allow self write, allow anonymous auth, deny all others. This ensures only the user themselves can modify their password, and anonymous binds can only verify passwords, but no one else can read them. <br>2. **Global read (anonymous):** `to dn.subtree="{{ _basedn }}"` – allow the local **external root** (the OS root user via SASL EXTERNAL bind) to manage everything, and allow all other users (including anonymous) read access to the entire directory. <br>These default rules mean that by default **passwords are protected, but all other directory entries can be read anonymously**. You can modify this list to tighten or loosen access as needed. The rules are applied in order and are set with `ordered: true` in the role. Use caution when editing if you are not familiar with OpenLDAP ACL syntax. |

</details>

## Tags

This role does **not define any specific Ansible tags** in its tasks. All tasks will run whenever the role is invoked (there are no included or skipped sections based on tags). You can still apply tags externally when including the role in a play, if you want to control role execution with `--tags`/`--skip-tags` at playbook run time – for example, tagging the role in a playbook as `role: open_ldap_setup tags: ['ldap','openldap']`. But by default, every task in this role always executes (assuming the role itself is included).

## Dependencies

* **Ansible Version:** This role requires Ansible **2.14+** (Ansible Core 2.14 or higher). It makes use of collection modules and certain syntax that are present in newer Ansible versions. Using the latest Ansible is recommended for full compatibility.
* **Collections:** The role relies on the **community.general** Ansible collection for LDAP modules. In particular, it uses `community.general.ldap_attrs` and `community.general.ldap_entry` modules to apply LDAP configuration changes. Make sure this collection is installed on your control machine before running the role. You can install it with:

  ```bash
  ansible-galaxy collection install community.general
  ```

  (If using Ansible 2.10+, collections are supported. In older versions, these modules won’t be available by default.)
* **Python LDAP library:** The target hosts need the **python-ldap** library for the LDAP modules to work. On Debian/Ubuntu, this is provided by the package **python3-ldap**, which the role will install automatically. Ensure your systems have internet access to retrieve packages or that the package is available in your local repository mirror.
* **No Role Dependencies:** There are no other Ansible roles that this role depends on (no dependencies listed in `meta/main.yml`). All necessary setup (package installs, etc.) is handled within this role. However, in a larger deployment, you might use this role alongside others (for example, a firewall role to open ports, or roles to populate LDAP data). These are not strictly required, but see **Cross-Referencing** for complementary roles.
* **Privileges:** This role should be run with **become: yes** (privileged execution), because it installs packages and modifies system configuration files. Moreover, the LDAP configuration tasks leverage a local **SASL EXTERNAL** bind to LDAP (over the ldapi UNIX socket) which requires root privileges on the target host. In practice, that means your Ansible play should either target a user with appropriate sudo rights or explicitly set `become: true` for this role’s tasks.

## Example Playbook

The following is an example of how to use the role in a playbook. It shows a minimal setup where we specify the domain and set a root password for the LDAP admin. This play will install OpenLDAP on all hosts in the **ldap_servers** group.

```yaml
- hosts: ldap_servers
  become: yes
  vars:
    openldap_server_domain: "example.net"
    openldap_server_rootpw: "StrongPassword123!"
  roles:
    - role: open_ldap_setup
      # Optionally, you could enable LDAPS (TLS) like so:
      # openldap_server_enable_tls: true
      # openldap_server_ssl_cert: "/etc/ldap/certs/ldap_example_net.crt"
      # openldap_server_ssl_key: "/etc/ldap/certs/ldap_example_net.key"
```

**Usage notes:** In the above example, the LDAP domain will be `dc=example,dc=net`. The admin DN will be `cn=Manager,dc=example,dc=net` with password "StrongPassword123!" (you should choose a safer password or, better, use a hashed value). The role will install slapd and initialize the directory. If you wanted to enable TLS, you would set `openldap_server_enable_tls: true` and provide the paths to your certificate and key (as shown in the commented lines). Ensure those files exist on the target or are deployed (the role does not generate or fetch them by default). After running this playbook, you should have a running LDAP server on each host, ready for use.

## Testing Instructions

It is highly recommended to test this role using **Molecule** (with the Docker driver) to verify its behavior before applying it to production. Molecule allows you to deploy the role in a disposable container or VM and check that everything converges correctly. You can follow these steps to test the `open_ldap_setup` role:

1. **Install Molecule (and Docker)** on your development machine. For example:

   ```bash
   pip install molecule[docker] 
   ```

   Make sure Docker is installed and running, since Molecule will use it to create test containers. You may need to run Molecule commands as a user with permission to manage Docker containers.

2. **Initialize a test scenario:** If this role comes with a Molecule scenario (e.g. a `molecule/default/` directory under the role), you can use that. If not, you can create one with:

   ```bash
   molecule init scenario -r open_ldap_setup -d docker
   ```

   This will create a `molecule/default` directory with a basic scenario for the role using the Docker driver.

3. **Configure the scenario (if needed):** Edit the `molecule.yml` and `converge.yml` in the scenario to suit your needs. By default, Molecule will use a Docker image like Debian (e.g. `docker.io/pycontribs/debian`) for testing. Ensure the image has systemd or adjust the scenario to start slapd without systemd if necessary (for simple tests, you might use the slapd init script directly). Also, set any required role vars in `converge.yml` (for example, you must set `openldap_server_rootpw` since it has no default).

4. **Run the role in a container:** Execute Molecule to run the role on a fresh container:

   ```bash
   molecule converge
   ```

   Molecule will build a container, apply the playbook (which includes the `open_ldap_setup` role), and report any changes or errors. On success, you should have an OpenLDAP server running inside the test container.

5. **Verify the results:** Once the converge step finishes, you can perform checks:

   * Enter the container: `docker exec -it <container_id> /bin/bash` (replace `<container_id>` with the Molecule container name, which is usually something like `instance`).
   * Verify slapd is running: For example, run `ps aux | grep slapd` to see the slapd process, or if systemd is running, `systemctl status slapd`. You should see that slapd is active.
   * Check that LDAP is listening on the expected port. For no-TLS, run `ss -ntl | grep 389` and you should see slapd listening on 0.0.0.0:389. If TLS is enabled in the test, check for port 636.
   * Perform a simple LDAP query to test functionality. For example, you can use the ldapsearch tool (already installed by the role as part of **ldap-utils**):

     ```bash
     ldapsearch -x -H ldap://localhost -b "dc=example,dc=net" -D "cn=Manager,dc=example,dc=net" -w StrongPassword123! -s base "(objectclass=*)"
     ```

     This should connect to the LDAP server and retrieve the base DN entry. If you see output containing `dc=example,dc=net` and associated attributes, the server is working. (Replace the base DN and password as appropriate for your test.)
   * (Optional) If you have enabled TLS in the test, you might test an LDAPS connection. Ensure the container has the openssl tool and run: `openssl s_client -connect localhost:636 -showcerts` to see if an SSL handshake succeeds. You could also use `ldapsearch -H ldaps://localhost:636 ...` with `-ZZ` for StartTLS if configured.

6. **Run Molecule verify (optional):** If you wrote any automated tests (e.g., with Testinfra or Goss) in the Molecule scenario, run `molecule verify` to execute them. By default, this role may not include explicit verify tests, so this step is optional.

7. **Cleanup:** When done, use `molecule destroy` to tear down the test container and free resources. Or simply run `molecule test` to do a full cycle (create, converge, verify, destroy) in one command.

Using Molecule ensures that the role is **idempotent** (running it multiple times yields no changes after the first run) and that it works on a clean system. It helps catch issues with package installation and configuration in an isolated environment. Before using this role on actual servers, it's good practice to molecule-test any changes you make to it.

## Known Issues and Gotchas

* **Admin password not hashed by default:** The role will set the LDAP admin password (olcRootPW) exactly to the value of `openldap_server_rootpw` provided. If you supply a plain-text string, that exact string is stored in the LDAP config database (under `cn=config`). This means the password is effectively in clear-text (Base64) in the slapd configuration. OpenLDAP does **not** automatically hash it for you. This is a security concern and also means if someone can read your config DB, they get the admin password. To avoid this, **provide a pre-hashed password** for `openldap_server_rootpw`. You can generate an SSHA hash using the `slappasswd` command-line tool (or other mechanisms) and use that (including the `{SSHA}` prefix) as the value. When using a hashed value, slapd will use it as-is for verification. (See **Security Implications** for more details.) In the future, the role could be enhanced to hash the password automatically, but currently it does not.

* **TLS configuration is not fully automated:** While the role has an option to enable TLS (`openldap_server_enable_tls: true`), the actual configuration of slapd’s TLS settings is incomplete. There are commented-out tasks in the role intended to set `olcTLSCertificateFile` and `olcTLSCertificateKeyFile` in the LDAP config, but they do not run by default. This means if you turn on TLS, slapd will be told (via `/etc/default/slapd`) to listen on LDAPS, but the LDAP server might not have any certificate configured to use. In practice, slapd could fail to start without certificate settings, or it may start but not actually allow secure connections. **Workaround:** Make sure to manually configure the certificate. You have a few options: (a) Prior to running the role, pre-configure slapd’s TLS settings (e.g. via a debconf or manual config) so that a certificate is already in place; (b) After the role runs (or by forking this role), use `community.general.ldap_attrs` to set `olcTLSCertificateFile` and `olcTLSCertificateKeyFile` to the paths of your cert and key (you can use the variables provided to the role). Unless you do something like this, simply setting `openldap_server_enable_tls: true` is not sufficient. Treat the TLS enable as a flag that you need to do additional steps. (If `openldap_server_generate_cert` is ever implemented, that would handle it by generating and configuring a self-signed cert, but as of now it’s not automatic.)

* **Replication tasks always applied (even if undesired):** The role contains two tasks at the end that configure **multi-master replication** between two LDAP servers. These tasks unconditionally add `olcSyncrepl` directives to the LDAP config, referencing hosts `master1` and `master2` with example credentials (`cn=admin,dc=example,dc=com` and password "secret"). If you run this role as-is on a host, it will attempt to configure that host as part of a multi-master pair using those sample values, regardless of whether you intended to set up replication. This is likely not what you want in most cases. If you are **not** setting up a two-node replication scenario, you should disable or remove these tasks. In an upcoming refactoring, this logic is expected to move to a dedicated `openldap_replication` role (as indeed there is one in this repository). For now, be aware that you might see changes to `olcSyncrepl` even if you don’t configure any replication variables. Those changes may not harm a single server (slapd will ignore a broken syncrepl config or log errors), but it’s cleaner to avoid them. **Workaround:** Use the `openldap_replication` role (and set `ldap_replication: false` when including this role, if such a toggle exists) or simply comment out the replication portion in this role’s tasks if you have access to modify it.

* **Base DN calculation for multi-part domains:** As mentioned, the default `_basedn` formula only takes the first two components of `openldap_server_domain`. If your domain is longer (e.g. **corp.example.co.uk**), the default `_basedn` would become `dc=corp,dc=example` – which is incomplete. This is a limitation of the default Jinja2 expression. In such cases, you must manually set `_basedn` to the full desired value in your play or inventory. For example:

  ```yaml
  openldap_server_domain: corp.example.co.uk  
  _basedn: "dc=corp,dc=example,dc=co,dc=uk"
  ```

  If you don’t, your LDAP server will be configured with an incorrect suffix and your directory entries might not align with what clients expect.

* **Firewall ports not opened by role:** If your servers have a firewall (like UFW or iptables) enabled by default, note that this role *does not* manage firewall rules itself. By default, slapd listens on port 389 (and 636 if TLS). You should ensure these ports are accessible to your LDAP clients. In this repository, there is a **UFW role** and the `group_vars/openldap.yml` file provides variables (`ufw_allow_ldap: true`, etc.) to open LDAP ports. But those take effect only if you apply the UFW role. Remember to include firewall configuration in your overall play if needed. Otherwise, after running this role, the LDAP service may be running but unreachable due to firewall blocks.

* **Re-running on existing LDAP installations:** This role is primarily aimed at fresh installations. If you run it on a host that already has slapd installed/configured, be aware that the tasks will attempt to enforce the settings given (domain, base DN, admin, etc.) on the existing configuration. The ldap_attrs tasks use `state: exact`, so they will modify attributes to match the provided values. This could, for example, change the DIT suffix or admin password of an existing server. Use caution and ensure that the values you set match or intentionally override the existing config. Also, adding the base DN entry with `ldap_entry` may fail if that entry already exists. Ideally, use this role to set up new servers or ensure idempotence by aligning it with the current state of your LDAP if used on an existing instance.

## Security Implications

Setting up an identity directory like OpenLDAP has several security considerations. This role attempts to set reasonable defaults, but you should be aware of the following:

* **Service User and Privileges:** The OpenLDAP server (slapd) runs under a dedicated system account **`openldap`** (not as root). This is a security best practice to limit the privileges of the service. The role ensures the slapd process runs as **openldap:openldap** by configuring the default init script `/etc/default/slapd` accordingly. Additionally, the role adds the `openldap` user to the `root` group. This unusual step is done so that slapd can read files that are owned by root (specifically, certificate files under `/etc/ldap` which might be root-owned). While this achieves the goal (allowing access to `/etc/ldap/certs/*`), adding a service account to the root group is typically not ideal from a security standpoint, as it broadens the account’s access. If possible, you may tighten this by restricting the certificate file permissions to just what’s needed (e.g. group `openldap` ownership of certs rather than making openldap user part of `root`). Nonetheless, running slapd as a non-root user is inherently safer than running it as root, and the default Debian setup with user `openldap` reflects that principle.

* **Network Exposure (LDAP Ports):** OpenLDAP by default will listen on TCP port **389** for LDAP (and  **636** for LDAPS if enabled). The role does not restrict or firewall this – it assumes you will handle firewalling separately. If your LDAP server is on a secured internal network, anonymous read access (see ACLs below) might be acceptable; however, if the server is accessible more broadly, you must consider the data exposure. It is **highly recommended** to firewall the LDAP service to only allow trusted clients or networks. In the context of this repository, you can use the **UFW role** to restrict access (the group vars enable LDAP ports by default, but you could limit allowed sources or disable if not needed). Always ensure that sensitive directory data is not exposed to the internet at large. If using TLS, still consider restricting access to mitigate brute-force or DDoS possibilities on the LDAP port.

* **Access Control & Data Confidentiality:** The default ACLs (`openldap_olcAccess`) configured by this role allow **read-only access to all data for everyone (including anonymous)**, with the exception of sensitive attributes like passwords. This means that unless you change the ACL, anyone who can connect to your LDAP server can query entries (for example, get a list of all users, their phone numbers, etc., depending on what you store in LDAP). In some deployments, open read access is intentional (e.g. a public directory or an address book service). In others, this is a security risk. Consider your use case: If you need to restrict data to authenticated users or specific groups, you should modify the `openldap_olcAccess` rules accordingly. For instance, you might add rules to disallow anonymous binds entirely or to restrict reads to authenticated binders. The role’s default ACL is somewhat permissive (it mirrors the typical default slapd example config where anonymous can read most entries). Make sure this aligns with your security requirements.

* **LDAP Admin Credentials:** The LDAP **root DN** (admin user) has full control over the directory. The password for this account (`openldap_server_rootpw`) must be kept secret. As noted in **Known Issues**, by default the role does not encrypt/hash this password before applying it. In the LDAP config database (`cn=config`), the password will appear in either plaintext or hashed form exactly as you provided. It’s strongly advised that you do **not** keep this password in plaintext in your playbooks or inventory. Use Ansible Vault to encrypt it, or supply it via an external mechanism (prompt or CI secret store). Furthermore, consider hashing it: e.g., instead of setting `openldap_server_rootpw: "MySecretPass"`, run `slappasswd` (on any machine with the OpenLDAP utilities) to generate a hash:

  ```bash
  $ slappasswd -s MySecretPass  
  {SSHA}N12Hun...<rest_of_hash>
  ```

  Take the resulting `{SSHA}...` value and use that as the variable value. The role will then set that as the admin password, and LDAP will treat it as an already-hashed secret. This way, even if someone reads the LDAP config, they cannot easily recover the plaintext password. Always rotate this admin password securely and avoid using the same password elsewhere.

* **Unencrypted Communications:** By default, the role sets up LDAP without encryption (no TLS). This means any LDAP simple binds (which include the username and password) and queries will travel over the network in clear text. If your LDAP clients connect over an untrusted network (or even a local network where others might sniff traffic), this can lead to credential compromise or information leakage. To address this, you should enable encryption. There are two primary ways: **LDAPS (port 636)** or **StartTLS on LDAP (port 389)**. This role is oriented toward LDAPS (controlled by `openldap_server_enable_tls`). If you enable it, ensure you have configured a proper certificate (`openldap_server_ssl_cert` and `openldap_server_ssl_key`). Clients will need to trust the certificate authority that signed your LDAP server’s cert (or you can use a public CA). If you use a self-signed cert (perhaps via a future `openldap_server_generate_cert` or manual process), you’ll need to distribute that cert to clients. If you cannot use LDAPS, consider configuring StartTLS (not explicitly covered by this role, but you could still use the certificate variables and manually allow StartTLS on port 389). In summary: **do not transmit sensitive LDAP binds in plaintext** on unencrypted channels – enable TLS or use other protective measures (VPNs, etc.).

* **File Permissions on Keys and Data:** The role stores LDAP data under `/var/lib/ldap` (default directory by slapd package) and config under `/etc/ldap/slapd.d` (config database files). These locations are by default owned by `openldap` user and are not world-accessible. The TLS certificate and key, if placed in `/etc/ldap/certs`, should be restricted in permissions. The role doesn’t explicitly set permissions on the cert/key, so ensure your certificate file is not world-readable (600 or 640 with appropriate owner/group). We rely on the fact that `openldap` is in root group (or you adjust group) to allow slapd to read the key. Keep in mind that if someone gains access to the key, they could impersonate your LDAP server. Similarly, backup any LDAP data dumps securely since they can contain all directory information including password hashes.

By understanding these implications and adjusting variables or environment settings accordingly, you can use the `open_ldap_setup` role to deploy an OpenLDAP server that meets your security requirements.

## Cross-Referencing

This role is one part of a suite of roles for managing an OpenLDAP ecosystem. In the same repository, you may find the following related roles and resources useful:

* **`openldap_content` role:** After setting up the LDAP server, you might want to populate it with initial directory content (e.g., base organizational units, groups, and users). The **openldap_content** role is designed to load LDIF files or use Ansible tasks to create common entries (such as People, Groups OUs, default groups, etc.). It complements `open_ldap_setup` by filling the directory with data once the server is running.

* **`openldap_replication` role:** If you need to configure multi-master or master-slave replication beyond the basic example in this role, the **openldap_replication** role should be used. It handles the proper setup of syncrepl agreements between LDAP servers. Rather than using the hard-coded snippet in `open_ldap_setup`, you would include `openldap_replication` (as shown in the repository’s `ldap-servers.yml` playbook) when `ldap_replication: true` to configure two servers to replicate. This keeps replication logic separate and more flexible.

* **`openldap_logging` role:** OpenLDAP can log operations and changes via syslog. The **openldap_logging** role (if present in this repo) likely configures the loglevel for slapd and possibly sets up a dedicated log file or syslog facility for LDAP logs. Use this role if you need detailed auditing or troubleshooting information from slapd (for example, to log all search queries or modifications).

* **`openldap_backup` role:** For periodic backups of your LDAP data, the **openldap_backup** role can be used. This might dump the LDAP database to an LDIF file on a schedule or when run. Regular backups are important for directory services to enable recovery from data loss or corruption. This role would ensure that backups are created and rotated safely.

* **Firewall (UFW) role:** As noted, if you need to manage firewall settings on your servers, consider using the repository’s **ufw** role. In `group_vars/openldap.yml`, the variables `ufw_allow_ldap` and `ufw_allow_ldaps` are set to true by default, meaning if you apply the UFW role, it will open ports 389 and 636 for LDAP traffic. There is also `ufw_allow_ports` listing these ports. This interplay suggests that to fully allow LDAP through the firewall, you should run the UFW role (which reads those vars) along with this role. The OpenLDAP setup role itself doesn’t alter firewall rules.

* **Integration with other services:** If you plan to use this LDAP server for authenticating applications (e.g., Grafana, Jenkins, Linux system logins via PAM/SSSD, etc.), you might want to look at roles or playbooks for those integrations. For instance, the repository’s **Grafana** role has optional LDAP integration which could be pointed at this LDAP server. Similarly, while not in this repo, an SSSD or PAM LDAP client configuration would be needed on client machines to authenticate against the LDAP directory.

* **Playbook example:** The repository contains an example playbook [`ldap-servers.yml`][ldap-servers.yml] which shows how these roles come together in practice. In that playbook, hosts in the `ldap_servers` group have `openldap_server` (this role) applied, followed by `openldap_content`, and conditionally `openldap_replication`, `openldap_logging`, and `openldap_backup`. This layered approach means: first set up the base server, then add content, then configure replication (if needed) and other extras. Refer to that playbook to understand the full deployment workflow and adjust your usage accordingly.

[ldap-servers.yml]: https://github.com/QiMata/ansible/blob/main/src/playbooks/ldap-servers.yml (Example LDAP servers playbook)

By using the above roles in combination, you can achieve a full-featured LDAP deployment. Each role focuses on a specific aspect (core server setup, populating data, replication, etc.), making it easier to maintain. Be sure to read the README of each related role for details on their usage (they will have similar documentation if expanded).

---

**Note:** This documentation is specific to the `open_ldap_setup` role. For more general information on OpenLDAP, you may refer to the official documentation or community guides. Understanding OpenLDAP concepts (like DIT structure, ACL syntax, and replication mechanisms) will help you get the most out of these roles. Always test changes in a safe environment before applying to production directories. Enjoy your LDAP deployment!
