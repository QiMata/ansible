---
- name: Install the openldap and required packages
  apt:
    name:
      - slapd
      - ldap-utils
      - openssl
      - db-util
      - "{{ 'python3-ldap' if ansible_python_version is version('3','>=') else 'python-ldap' }}"
    update_cache: true

- name: Install the openldap and required packages for legacy distros
  apt:
    name:
      - python-selinux
  when:
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_major_version|int < 20

- name: Add openldap user to root group (ssl keys access)
  user:
    name: openldap
    append: true
    groups: root

- name: Copy default config
  template:
    src: slapd.j2
    dest: /etc/default/slapd
    mode: 0755
  notify: restart slapd

- name: Make sure slapd is enabled and running
  systemd:
    name: slapd
    state: started
    enabled: true

- name: Configure basedn as default suffix
  community.general.ldap_attrs:
    dn: olcDatabase={1}mdb,cn=config
    attributes:
      olcSuffix: "{{ _basedn }}"
    state: exact

- name: Set up a root user
  community.general.ldap_attrs:
    dn: olcDatabase={1}mdb,cn=config
    attributes:
      olcRootDN: "{{ openldap_server_rootdn }}"
      olcRootPW: "{{ openldap_server_rootpw }}"
    state: exact

- name: Set up the ACL
  community.general.ldap_attrs:
    dn: olcDatabase={1}mdb,cn=config
    attributes:
      olcAccess: "{{ openldap_olcaccess }}"
    ordered: true
    state: exact

- name: Generate basedn
  community.general.ldap_entry:
    dn: "{{ _basedn }}"
    objectClass: domain

# - name: Load encryption config
#   community.general.ldap_attrs:
#     dn: cn=config
#     attributes:
#       olcTLSCertificateKeyFile: "{{ openldap_server_ssl_key }}"
#       olcTLSCertificateFile: "{{ openldap_server_ssl_cert }}"
#     state: exact
#   when: openldap_server_enable_tls
#   notify: restart slapd

- name: Set up syncrepl on Master 1
  community.general.ldap_attrs:
    dn: olcDatabase={1}mdb,cn=config
    attributes:
      olcSyncrepl: >
        rid=001 provider=ldap://master2 bindmethod=simple binddn="cn=admin,dc=example,dc=com" 
        credentials=secret searchbase="dc=example,dc=com" type=refreshAndPersist retry="5 5 300 5" timeout=1
      olcMirrorMode: TRUE
    state: exact

- name: Set up syncrepl on Master 2
  community.general.ldap_attrs:
    dn: olcDatabase={1}mdb,cn=config
    attributes:
      olcSyncrepl: >
        rid=002 provider=ldap://master1 bindmethod=simple binddn="cn=admin,dc=example,dc=com" 
        credentials=secret searchbase="dc=example,dc=com" type=refreshAndPersist retry="5 5 300 5" timeout=1
      olcMirrorMode: TRUE
    state: exact

- name: Start and enable OpenLDAP service
  systemd:
    name: slapd
    state: started
    enabled: yes
