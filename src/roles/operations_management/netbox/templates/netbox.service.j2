[Unit]
Description=NetBox WSGI Service
After=network.target postgresql.service redis.service
Wants=postgresql.service redis.service

[Service]
Type=simple
User={{ operations_management_netbox_user }}
Group={{ operations_management_netbox_user }}
WorkingDirectory={{ operations_management_netbox_install_dir }}/netbox
ExecStart={{ operations_management_netbox_venv }}/bin/gunicorn \
    --workers {{ operations_management_netbox_gunicorn_workers }} \
    --threads {{ operations_management_netbox_gunicorn_threads }} \
    --timeout {{ operations_management_netbox_gunicorn_timeout }} \
    --keepalive {{ operations_management_netbox_gunicorn_keepalive }} \
    --max-requests {{ operations_management_netbox_gunicorn_max_requests }} \
    --max-requests-jitter {{ operations_management_netbox_gunicorn_max_requests_jitter }} \
    --bind 0.0.0.0:8000 \
    --access-logfile /var/log/netbox/access.log \
    --error-logfile /var/log/netbox/error.log \
    --capture-output \
    --enable-stdio-inheritance \
    netbox.wsgi
Environment="DJANGO_SETTINGS_MODULE=netbox.settings"
Environment="PYTHONPATH={{ operations_management_netbox_install_dir }}/netbox"
Restart=always
RestartSec=5
TimeoutStopSec=30

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths={{ operations_management_netbox_install_dir }} /var/log/netbox {{ operations_management_netbox_media_root }}

# Resource limits
LimitNOFILE=65536
MemoryAccounting=true
{% if netbox_memory_limit is defined %}
MemoryMax={{ netbox_memory_limit }}
{% endif %}

[Install]
WantedBy=multi-user.target
