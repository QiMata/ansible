#!/bin/bash
# NetBox Health Check Script

NETBOX_URL="${1:-http://localhost:8000}"
HEALTH_ENDPOINT="${NETBOX_URL}{{ operations_management_netbox_health_check_path }}"
TIMEOUT=10
MAX_RETRIES=3

check_service() {
    local service_name="$1"
    if systemctl is-active --quiet "$service_name"; then
        echo "✓ $service_name is running"
        return 0
    else
        echo "✗ $service_name is not running"
        return 1
    fi
}

check_endpoint() {
    local url="$1"
    local description="$2"
    
    if curl -sf --max-time "$TIMEOUT" "$url" > /dev/null 2>&1; then
        echo "✓ $description is accessible"
        return 0
    else
        echo "✗ $description is not accessible"
        return 1
    fi
}

check_database() {
    {{ operations_management_netbox_venv }}/bin/python {{ operations_management_netbox_install_dir }}/netbox/manage.py shell << EOF
try:
    from django.db import connection
    cursor = connection.cursor()
    cursor.execute("SELECT 1")
    print("✓ Database connection successful")
except Exception as e:
    print(f"✗ Database connection failed: {e}")
    exit(1)
EOF
}

check_redis() {
    {{ operations_management_netbox_venv }}/bin/python {{ operations_management_netbox_install_dir }}/netbox/manage.py shell << EOF
try:
    import redis
    r = redis.Redis(host='{{ redis_host }}', port={{ redis_port }}, db=0)
    r.ping()
    print("✓ Redis connection successful")
except Exception as e:
    print(f"✗ Redis connection failed: {e}")
    exit(1)
EOF
}

main() {
    echo "NetBox Health Check"
    echo "==================="
    
    local exit_code=0
    
    # Check services
    check_service "netbox" || exit_code=1
{% if operations_management_netbox_rq_enabled %}
    check_service "netbox-rq" || exit_code=1
{% endif %}
{% if operations_management_netbox_nginx_enabled %}
    check_service "nginx" || exit_code=1
{% endif %}
    
    # Check endpoints
    check_endpoint "$HEALTH_ENDPOINT" "NetBox health endpoint" || exit_code=1
    
    # Check dependencies
    check_database || exit_code=1
    check_redis || exit_code=1
    
    echo "==================="
    if [ $exit_code -eq 0 ]; then
        echo "✓ All health checks passed"
    else
        echo "✗ Some health checks failed"
    fi
    
    return $exit_code
}

main "$@"
