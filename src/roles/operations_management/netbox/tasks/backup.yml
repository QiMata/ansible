---
- name: Create backup directory
  ansible.builtin.file:
    path: "{{ operations_management_netbox_backup_dir }}"
    state: directory
    owner: "{{ operations_management_netbox_user }}"
    group: "{{ operations_management_netbox_user }}"
    mode: '0750'
  when: operations_management_netbox_backup_enabled | bool

- name: Install backup dependencies
  ansible.builtin.apt:
    name:
      - postgresql-client
    state: present
  when: operations_management_netbox_backup_enabled | bool

- name: Create backup script
  ansible.builtin.template:
    src: netbox-backup.sh.j2
    dest: /usr/local/bin/netbox-backup
    mode: '0750'
    owner: root
    group: "{{ operations_management_netbox_user }}"
  when: operations_management_netbox_backup_enabled | bool

- name: Create backup cron job
  ansible.builtin.cron:
    name: "NetBox Automated Backup"
    minute: "{{ operations_management_netbox_backup_schedule.split()[0] }}"
    hour: "{{ operations_management_netbox_backup_schedule.split()[1] }}"
    day: "{{ operations_management_netbox_backup_schedule.split()[2] }}"
    month: "{{ operations_management_netbox_backup_schedule.split()[3] }}"
    weekday: "{{ operations_management_netbox_backup_schedule.split()[4] }}"
    job: "/usr/local/bin/netbox-backup"
    user: "{{ operations_management_netbox_user }}"
  when: operations_management_netbox_backup_enabled | bool

- name: Remove backup script
  ansible.builtin.file:
    path: /usr/local/bin/netbox-backup
    state: absent
  when: not (operations_management_netbox_backup_enabled | bool)

- name: Remove backup cron job
  ansible.builtin.cron:
    name: "NetBox Automated Backup"
    state: absent
    user: "{{ operations_management_netbox_user }}"
  when: not (operations_management_netbox_backup_enabled | bool)
