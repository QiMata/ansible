---
- name: Ensure curl present
  ansible.builtin.package:
    name: curl
    state: present

- name: Prepare install command
  ansible.builtin.set_fact:
    k3s_install_cmd: >-
      curl -sfL https://get.k3s.io |
      {{ 'INSTALL_K3S_VERSION=' + k3s_version if k3s_version|length > 0 else '' }}
      sh -s -
      {{ 'agent ' + k3s_agent_args if k3s_agent else 'server ' + k3s_server_args }}

- name: Install K3s
  ansible.builtin.shell: |
    set -o pipefail
    {{ k3s_install_cmd }}
  args:
    executable: /bin/bash
    creates: /usr/local/bin/k3s
  register: k3s_result

- name: Ensure k3s service enabled and started (server)
  ansible.builtin.service:
    name: k3s
    enabled: true
    state: started
  when: (not k3s_agent) and (k3s_enable_service | default(true))

- name: Ensure k3s-agent service enabled and started (agent)
  ansible.builtin.service:
    name: k3s-agent
    enabled: true
    state: started
  when: k3s_agent and (k3s_enable_service | default(true))
