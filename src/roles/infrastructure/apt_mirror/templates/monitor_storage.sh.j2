#!/bin/bash
# Storage Monitoring Script for apt-mirror
# Generated by Ansible - Do not edit manually

MIRROR_PATH="{{ apt_mirror_base_path }}"
THRESHOLD={{ apt_mirror_storage_alert_threshold }}
ALERT_MANAGER="/opt/apt-mirror-alerts/alert_manager.py"

# Get disk usage percentage
USAGE=$(df "$MIRROR_PATH" | awk 'NR==2 {print $5}' | sed 's/%//')

if [ "$USAGE" -ge "$THRESHOLD" ]; then
    SEVERITY="warning"
    if [ "$USAGE" -ge $((THRESHOLD + 10)) ]; then
        SEVERITY="critical"
    fi
    
    MESSAGE="Mirror storage usage is at ${USAGE}% (threshold: ${THRESHOLD}%)
Path: $MIRROR_PATH
Available space: $(df -h "$MIRROR_PATH" | awk 'NR==2 {print $4}')
Used space: $(df -h "$MIRROR_PATH" | awk 'NR==2 {print $3}')

Please consider:
- Running manual cleanup: apt-mirror clean
- Increasing storage capacity
- Reviewing mirror configuration for unnecessary components"

    python3 "$ALERT_MANAGER" "storage_${SEVERITY}" "Storage ${SEVERITY}: ${USAGE}% used" "$MESSAGE"
fi
