# APT Mirror Health Check Apache Configuration
# Generated by Ansible - Do not edit manually

<VirtualHost *:{{ apt_mirror_health_check_port }}>
    ServerName {{ ansible_fqdn }}
    DocumentRoot /var/www/html
    
    # Proxy health check requests to the health service
    ProxyPreserveHost On
    ProxyRequests Off
    
    ProxyPass {{ apt_mirror_health_check_endpoint }} http://localhost:{{ apt_mirror_health_service_port }}{{ apt_mirror_health_check_endpoint }}
    ProxyPassReverse {{ apt_mirror_health_check_endpoint }} http://localhost:{{ apt_mirror_health_service_port }}{{ apt_mirror_health_check_endpoint }}
    
    # Health check endpoints
    ProxyPass /health/disk http://localhost:{{ apt_mirror_health_service_port }}/health/disk
    ProxyPassReverse /health/disk http://localhost:{{ apt_mirror_health_service_port }}/health/disk
    
    ProxyPass /health/sync http://localhost:{{ apt_mirror_health_service_port }}/health/sync
    ProxyPassReverse /health/sync http://localhost:{{ apt_mirror_health_service_port }}/health/sync
    
    ProxyPass /health/apache http://localhost:{{ apt_mirror_health_service_port }}/health/apache
    ProxyPassReverse /health/apache http://localhost:{{ apt_mirror_health_service_port }}/health/apache
    
    ProxyPass /health/mirror http://localhost:{{ apt_mirror_health_service_port }}/health/mirror
    ProxyPassReverse /health/mirror http://localhost:{{ apt_mirror_health_service_port }}/health/mirror
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/apt-mirror-health-error.log
    CustomLog ${APACHE_LOG_DIR}/apt-mirror-health-access.log combined
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    
{% if apt_mirror_client_registration_enabled %}
    # Client registration endpoint
    <Location "/register">
    ProxyPass http://localhost:{{ apt_mirror_health_service_port }}/register
    ProxyPassReverse http://localhost:{{ apt_mirror_health_service_port }}/register
        
        # Allow registration from internal networks only
        Require ip 10.0.0.0/8
        Require ip 172.16.0.0/12
        Require ip 192.168.0.0/16
    </Location>
{% endif %}
</VirtualHost>
