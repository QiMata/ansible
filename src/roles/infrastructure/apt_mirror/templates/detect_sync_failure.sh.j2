#!/bin/bash
# Sync Failure Detection Script for apt-mirror
# Generated by Ansible - Do not edit manually

MIRROR_PATH="{{ apt_mirror_base_path }}"
LOG_FILE="$MIRROR_PATH/var/cron.log"
ALERT_MANAGER="/opt/apt-mirror-alerts/alert_manager.py"

# Check if log file exists
if [ ! -f "$LOG_FILE" ]; then
    MESSAGE="APT mirror cron log file not found at $LOG_FILE
This may indicate that apt-mirror has never run or there's a configuration issue."
    
    python3 "$ALERT_MANAGER" "sync_failure" "Sync Log Missing" "$MESSAGE"
    exit 1
fi

# Check for recent failures in the log
RECENT_ERRORS=$(tail -n 100 "$LOG_FILE" | grep -i "error\|failed\|fatal" | tail -n 5)

if [ -n "$RECENT_ERRORS" ]; then
    # Check if these are recent (within last 24 hours)
    YESTERDAY=$(date -d "24 hours ago" +"%Y-%m-%d")
    RECENT_FAILURES=$(echo "$RECENT_ERRORS" | grep "$YESTERDAY\|$(date +%Y-%m-%d)")
    
    if [ -n "$RECENT_FAILURES" ]; then
        MESSAGE="Recent sync failures detected in apt-mirror:

$RECENT_FAILURES

Log file: $LOG_FILE

Please check:
- Network connectivity to upstream mirrors
- Disk space availability
- Mirror configuration validity
- Upstream mirror status"

        python3 "$ALERT_MANAGER" "sync_failure" "APT Mirror Sync Failures" "$MESSAGE"
    fi
fi

# Check last sync time
LAST_SYNC_FILE="$MIRROR_PATH/var/last_sync"
if [ -f "$LAST_SYNC_FILE" ]; then
    LAST_SYNC_TIME=$(stat -c %Y "$LAST_SYNC_FILE")
    CURRENT_TIME=$(date +%s)
    HOURS_SINCE_SYNC=$(( (CURRENT_TIME - LAST_SYNC_TIME) / 3600 ))
    
    if [ $HOURS_SINCE_SYNC -gt 48 ]; then
        MESSAGE="APT mirror has not synced successfully in $HOURS_SINCE_SYNC hours.
Last sync: $(date -d @$LAST_SYNC_TIME)

This may indicate:
- Cron job not running
- Sync process hanging or failing
- Configuration issues

Please investigate the sync process and check system resources."

        python3 "$ALERT_MANAGER" "sync_failure" "Mirror Sync Overdue" "$MESSAGE"
    fi
fi
