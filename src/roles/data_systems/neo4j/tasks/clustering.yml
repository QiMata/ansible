---
# Advanced Clustering Configuration

- name: Configure cluster discovery
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.cluster.discovery.type="
    line: "dbms.cluster.discovery.type={{ neo4j_cluster_discovery_type }}"
  notify: restart neo4j
  when: neo4j_cluster_enabled

- name: Configure cluster routing TTL
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.routing.ttl="
    line: "dbms.routing.ttl={{ neo4j_cluster_routing_ttl }}"
  notify: restart neo4j
  when: neo4j_cluster_enabled

- name: Configure cluster topology refresh
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.cluster.topology.refresh="
    line: "dbms.cluster.topology.refresh={{ neo4j_cluster_topology_refresh }}"
  notify: restart neo4j
  when: neo4j_cluster_enabled

- name: Configure cluster catch-up timeout
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.cluster.catch-up.client_inactivity_timeout="
    line: "dbms.cluster.catch-up.client_inactivity_timeout={{ neo4j_cluster_catch_up_timeout }}"
  notify: restart neo4j
  when: neo4j_cluster_enabled

- name: Configure cluster join timeout
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.cluster.join_timeout="
    line: "dbms.cluster.join_timeout={{ neo4j_cluster_join_timeout }}"
  notify: restart neo4j
  when: neo4j_cluster_enabled

- name: Configure minimum core cluster size at formation
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.cluster.minimum_core_cluster_size_at_formation="
    line: "dbms.cluster.minimum_core_cluster_size_at_formation={{ neo4j_cluster_minimum_core_cluster_size_at_formation }}"
  notify: restart neo4j
  when: neo4j_cluster_enabled

- name: Configure minimum core cluster size at runtime
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.cluster.minimum_core_cluster_size_at_runtime="
    line: "dbms.cluster.minimum_core_cluster_size_at_runtime={{ neo4j_cluster_minimum_core_cluster_size_at_runtime }}"
  notify: restart neo4j
  when: neo4j_cluster_enabled

- name: Configure cluster member addresses (LIST discovery)
  ansible.builtin.lineinfile:
    path: /etc/neo4j/neo4j.conf
    regexp: "^#?dbms.cluster.discovery.endpoints="
    line: >-
      dbms.cluster.discovery.endpoints={{
        groups['neo4j_core']
        | map('extract', hostvars, 'ansible_default_ipv4')
        | map(attribute='address')
        | map('regex_replace', '^(.*)$', '\\1:5000')
        | join(',')
      }}
  notify: restart neo4j
  when:
    - neo4j_cluster_enabled
    - neo4j_cluster_discovery_type == "LIST"
    - groups['neo4j_core'] is defined

- name: Verify cluster health
  ansible.builtin.uri:
    url: "http://{{ neo4j_listen_address }}:{{ neo4j_http_port }}/db/cluster/overview"
    method: GET
    user: neo4j
    password: "{{ neo4j_initial_password }}"
    force_basic_auth: true
    status_code: 200
  register: cluster_health
  until: cluster_health.status == 200
  retries: 5
  delay: 10
  when:
    - neo4j_cluster_enabled
    - neo4j_initial_password | length > 0
