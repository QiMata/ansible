#!/bin/bash
# Neo4j Health Check Script
# Generated by Ansible

set -euo pipefail

CHECK_TYPE="${1:-database_available}"
HOST="{{ neo4j_listen_address }}"
HTTP_PORT="{{ neo4j_http_port }}"
BOLT_PORT="{{ neo4j_bolt_port }}"
USERNAME="neo4j"
PASSWORD="{{ neo4j_initial_password }}"

case "${CHECK_TYPE}" in
    "database_available")
        echo "Checking database availability..."
        response=$(curl -s -w "%{http_code}" -u "${USERNAME}:${PASSWORD}" \
            "http://${HOST}:${HTTP_PORT}/db/neo4j/tx/commit" \
            -H "Content-Type: application/json" \
            -d '{"statements":[{"statement":"RETURN 1 as health"}]}' \
            -o /dev/null)
        
        if [ "${response}" = "200" ]; then
            echo "✓ Database is available"
            exit 0
        else
            echo "✗ Database is not available (HTTP ${response})"
            exit 1
        fi
        ;;
        
    "cluster_healthy")
{% if neo4j_cluster_enabled %}
        echo "Checking cluster health..."
        response=$(curl -s -u "${USERNAME}:${PASSWORD}" \
            "http://${HOST}:${HTTP_PORT}/db/cluster/overview" \
            -H "Accept: application/json")
        
        if echo "${response}" | jq -e '.core | length > 0' > /dev/null 2>&1; then
            echo "✓ Cluster is healthy"
            exit 0
        else
            echo "✗ Cluster is not healthy"
            echo "${response}"
            exit 1
        fi
{% else %}
        echo "✓ Cluster check skipped (not configured)"
        exit 0
{% endif %}
        ;;
        
    *)
        echo "Unknown check type: ${CHECK_TYPE}"
        exit 1
        ;;
esac
