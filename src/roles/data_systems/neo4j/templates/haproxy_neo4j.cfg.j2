# HAProxy configuration for Neo4j
# Generated by Ansible

# Neo4j Backend Configuration
backend neo4j_bolt
    mode tcp
    balance roundrobin
    option tcp-check
{% for host in groups['neo4j_core'] | default([]) %}
    server neo4j-core-{{ loop.index }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:7687 check port 7687 inter 3s rise 2 fall 3
{% endfor %}
{% for host in groups['neo4j_replica'] | default([]) %}
    server neo4j-replica-{{ loop.index }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:7687 check port 7687 inter 3s rise 2 fall 3
{% endfor %}

backend neo4j_http
    mode http
    balance roundrobin
    option httpchk GET /db/cluster/writable
{% for host in groups['neo4j_core'] | default([]) %}
    server neo4j-core-{{ loop.index }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ neo4j_https_port if neo4j_https_enabled else neo4j_http_port }} check port {{ neo4j_https_port if neo4j_https_enabled else neo4j_http_port }} inter 3s rise 2 fall 3
{% endfor %}

# Frontend Configuration
frontend neo4j_bolt_frontend
    mode tcp
    bind *:7687
    default_backend neo4j_bolt

frontend neo4j_http_frontend
    mode http
    bind *:{{ neo4j_https_port if neo4j_https_enabled else neo4j_http_port }}
    default_backend neo4j_http

# Statistics
listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 30s
    stats admin if TRUE
