---
- name: Converge
  hosts: all
  become: true
  vars:
    db_name: testdb
    db_user: postgres
  tasks:
    - name: Install PostgreSQL server
      ansible.builtin.apt:
        name: postgresql
        state: present
        update_cache: true

    - name: Ensure database exists
      become_user: postgres
      community.postgresql.postgresql_db:
        name: "{{ db_name }}"
      failed_when: false
      become: true

    - name: Apply postgres_backup role  # noqa role-name[path]
      ansible.builtin.import_role:
        name: ../..
      vars:
        db_name: "{{ db_name }}"
        db_user: "{{ db_user }}"
        backup_dir: /var/backups/postgres
