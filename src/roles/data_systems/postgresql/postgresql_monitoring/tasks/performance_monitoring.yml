---
- name: Configure slow query logging
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: "^#?log_min_duration_statement"
    line: "log_min_duration_statement = {{ postgresql_slow_query_threshold }}"
    backup: true
  notify: Restart PostgreSQL
  become: true

- name: Enable query logging
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: "^#?log_statement"
    line: "log_statement = 'all'"
    backup: true
  notify: Restart PostgreSQL
  become: true

- name: Configure log line prefix for better parsing
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: "^#?log_line_prefix"
    line: "log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '"
    backup: true
  notify: Restart PostgreSQL
  become: true

- name: Enable statistics collector
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: "^#?track_activities"
    line: "track_activities = on"
    backup: true
  notify: Restart PostgreSQL
  become: true

- name: Enable statement statistics
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: "^#?track_counts"
    line: "track_counts = on"
    backup: true
  notify: Restart PostgreSQL
  become: true

- name: Configure shared_preload_libraries for pg_stat_statements
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: "^#?shared_preload_libraries"
    line: "shared_preload_libraries = 'pg_stat_statements'"
    backup: true
  notify: Restart PostgreSQL
  become: true

- name: Create pg_stat_statements extension
  community.postgresql.postgresql_ext:
    name: pg_stat_statements
    login_db: "{{ postgresql_exporter_database }}"
    state: present
  become: true
  become_user: postgres
