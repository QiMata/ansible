---
- name: Generate private key for PostgreSQL
  community.crypto.openssl_privatekey:
    path: "{{ postgresql_ssl_key_path }}"
    size: 2048
    owner: postgres
    group: postgres
    mode: '0600'

- name: Generate certificate signing request (CSR)
  community.crypto.openssl_csr:
    path: "/tmp/postgresql.csr"
    privatekey_path: "{{ postgresql_ssl_key_path }}"
    country_name: "{{ postgresql_ssl_cert_country }}"
    state_or_province_name: "{{ postgresql_ssl_cert_state }}"
    locality_name: "{{ postgresql_ssl_cert_locality }}"
    organization_name: "{{ postgresql_ssl_cert_organization }}"
    organizational_unit_name: "{{ postgresql_ssl_cert_organizational_unit }}"
    common_name: "{{ postgresql_ssl_cert_common_name }}"
    email_address: "{{ postgresql_ssl_cert_email }}"
    subject_alt_name:
      - "DNS:{{ postgresql_ssl_cert_common_name }}"
      - "DNS:localhost"
      - "IP:127.0.0.1"
      - "IP:{{ ansible_default_ipv4.address }}"

- name: Generate self-signed certificate
  community.crypto.x509_certificate:
    path: "{{ postgresql_ssl_cert_path }}"
    privatekey_path: "{{ postgresql_ssl_key_path }}"
    csr_path: "/tmp/postgresql.csr"
    provider: selfsigned
    selfsigned_not_after: "+{{ postgresql_ssl_cert_days }}d"
    owner: postgres
    group: postgres
    mode: '0644'

- name: Create CA certificate (copy of self-signed cert for client verification)
  ansible.builtin.copy:
    src: "{{ postgresql_ssl_cert_path }}"
    dest: "{{ postgresql_ssl_ca_file }}"
    owner: postgres
    group: postgres
    mode: '0644'
    remote_src: true

- name: Remove temporary CSR file
  ansible.builtin.file:
    path: "/tmp/postgresql.csr"
    state: absent
