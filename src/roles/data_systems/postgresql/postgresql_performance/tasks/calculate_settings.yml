---
- name: Get system memory information
  ansible.builtin.setup:
    filter: ansible_memtotal_mb

- name: Get CPU information
  ansible.builtin.setup:
    filter: ansible_processor_vcpus

- name: Calculate optimal PostgreSQL settings
  ansible.builtin.set_fact:
    calculated_shared_buffers: "{{ (ansible_memtotal_mb * 0.25) | int }}MB"
    calculated_effective_cache_size: "{{ (ansible_memtotal_mb * 0.75) | int }}MB"
    calculated_maintenance_work_mem: "{{ [(ansible_memtotal_mb * 0.05) | int, 2048] | min }}MB"
  when: postgresql_auto_tune | bool

- name: Determine max connection scaling values
  ansible.builtin.set_fact:
    _postgresql_max_connection_divisor: "{{ {'production': 10, 'staging': 20}.get(postgresql_tune_for_environment, 40) }}"
    _postgresql_max_connection_cap: "{{ {'production': 200, 'staging': 100}.get(postgresql_tune_for_environment, 50) }}"
  when: postgresql_auto_tune | bool

- name: Calculate optimal max connections
  ansible.builtin.set_fact:
    calculated_max_connections: "{{ [(ansible_memtotal_mb / (_postgresql_max_connection_divisor | int)) | int, (_postgresql_max_connection_cap | int)] | min }}"
  when: postgresql_auto_tune | bool

- name: Calculate work_mem based on connections and memory
  ansible.builtin.set_fact:
    calculated_work_mem: "{{ ((ansible_memtotal_mb * 0.25) / calculated_max_connections | int) | int }}MB"
  when: postgresql_auto_tune | bool

- name: Calculate wal_buffers (3% of shared_buffers, min 64kB, max 16MB)
  ansible.builtin.set_fact:
    calculated_wal_buffers: "{{ [[(calculated_shared_buffers | regex_replace('MB', '') | int * 0.03) | int, 1] | max, 16] | min }}MB"
  when: postgresql_auto_tune | bool

- name: Set environment-specific overrides
  ansible.builtin.set_fact:
    env_config: "{{ postgresql_performance_environments[postgresql_tune_for_environment] }}"
  when: postgresql_tune_for_environment in postgresql_performance_environments

- name: Apply calculated settings
  ansible.builtin.set_fact:
    final_shared_buffers: >-
      {{
        (postgresql_shared_buffers == 'auto')
        | ternary(calculated_shared_buffers | default(postgresql_shared_buffers), postgresql_shared_buffers)
      }}
    final_effective_cache_size: >-
      {{
        (postgresql_effective_cache_size == 'auto')
        | ternary(calculated_effective_cache_size | default(postgresql_effective_cache_size), postgresql_effective_cache_size)
      }}
    final_work_mem: >-
      {{
        (postgresql_work_mem == 'auto')
        | ternary(calculated_work_mem | default(postgresql_work_mem), postgresql_work_mem)
      }}
    final_maintenance_work_mem: >-
      {{
        (postgresql_maintenance_work_mem == 'auto')
        | ternary(calculated_maintenance_work_mem | default(postgresql_maintenance_work_mem), postgresql_maintenance_work_mem)
      }}
    final_max_connections: >-
      {{
        (postgresql_max_connections_tuned == 'auto')
        | ternary(calculated_max_connections | default(postgresql_max_connections_tuned), postgresql_max_connections_tuned)
      }}
    final_wal_buffers: >-
      {{
        (postgresql_wal_buffers == 'auto')
        | ternary(calculated_wal_buffers | default(postgresql_wal_buffers), postgresql_wal_buffers)
      }}

- name: Display calculated performance settings
  ansible.builtin.debug:
    msg:
      - "System Memory: {{ ansible_memtotal_mb }}MB"
      - "CPU Cores: {{ ansible_processor_vcpus }}"
      - "Environment: {{ postgresql_tune_for_environment }}"
      - "Calculated Settings:"
      - "  shared_buffers: {{ final_shared_buffers }}"
      - "  effective_cache_size: {{ final_effective_cache_size }}"
      - "  work_mem: {{ final_work_mem }}"
      - "  maintenance_work_mem: {{ final_maintenance_work_mem }}"
      - "  max_connections: {{ final_max_connections }}"
      - "  wal_buffers: {{ final_wal_buffers }}"
