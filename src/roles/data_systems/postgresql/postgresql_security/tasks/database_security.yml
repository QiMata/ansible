---
- name: Revoke default privileges from public schema
  community.postgresql.postgresql_query:
    login_db: postgres
    query: |
      REVOKE CREATE ON SCHEMA public FROM PUBLIC;
      REVOKE ALL ON DATABASE postgres FROM PUBLIC;
  become_user: postgres
  when: postgresql_public_schema_restricted | bool
  become: true

- name: Set secure default privileges for new objects
  community.postgresql.postgresql_query:
    login_db: postgres
    query: |
      ALTER DEFAULT PRIVILEGES IN SCHEMA public REVOKE ALL ON TABLES FROM PUBLIC;
      ALTER DEFAULT PRIVILEGES IN SCHEMA public REVOKE ALL ON SEQUENCES FROM PUBLIC;
      ALTER DEFAULT PRIVILEGES IN SCHEMA public REVOKE ALL ON FUNCTIONS FROM PUBLIC;
  become_user: postgres
  when: postgresql_default_privileges_revoked | bool
  become: true

- name: Create security monitoring views
  community.postgresql.postgresql_query:
    login_db: postgres
    query: |
      CREATE OR REPLACE VIEW security_failed_logins AS
      SELECT
        EXTRACT(EPOCH FROM log_time) as timestamp,
        user_name,
        database_name,
        connection_from,
        message
      FROM pg_log
      WHERE message LIKE '%authentication failed%'
      ORDER BY log_time DESC;

      CREATE OR REPLACE VIEW security_suspicious_queries AS
      SELECT
        EXTRACT(EPOCH FROM log_time) as timestamp,
        user_name,
        database_name,
        query,
        message
      FROM pg_log
      WHERE message LIKE '%DROP%' OR message LIKE '%DELETE%' OR message LIKE '%TRUNCATE%'
      ORDER BY log_time DESC;
  become_user: postgres
  when: postgresql_security_monitoring_enabled | bool
  become: true
