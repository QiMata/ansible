---
# ============================================================================
# MONITORING AND ALERTING TASKS
# ============================================================================

- name: Configure monitoring settings
  ansible.builtin.template:
    src: monitoring.yml.j2
    dest: /etc/elasticsearch/monitoring.yml
    owner: root
    group: elasticsearch
    mode: '0640'
  when: es_enable_monitoring
  notify: restart elasticsearch

- name: Enable monitoring collection
  ansible.builtin.uri:
    url: "http://{{ es_network_host }}:{{ es_proxy_settings.http_port | default(9200) }}/_cluster/settings"
    method: PUT
    body_format: json
    body:
      persistent:
        xpack:
          monitoring:
            collection:
              enabled: "{{ es_monitoring_collection_enabled | lower }}"
    headers:
      Content-Type: "application/json"
    status_code: [200, 400]
  when: 
    - es_enable_monitoring
    - es_wait_for_cluster
  ignore_errors: true
  delegate_to: "{{ groups['elasticsearch_cluster'][0] | default(inventory_hostname) }}"
  run_once: true

- name: Configure monitoring exporters
  ansible.builtin.uri:
    url: "http://{{ es_network_host }}:{{ es_proxy_settings.http_port | default(9200) }}/_cluster/settings"
    method: PUT
    body_format: json
    body:
      persistent:
        xpack:
          monitoring:
            exporters: "{{ es_monitoring_exporters }}"
    headers:
      Content-Type: "application/json"
    status_code: [200, 400]
  when: 
    - es_enable_monitoring
    - es_monitoring_exporters | length > 0
    - es_wait_for_cluster
  ignore_errors: true
  delegate_to: "{{ groups['elasticsearch_cluster'][0] | default(inventory_hostname) }}"
  run_once: true

- name: Enable Watcher
  ansible.builtin.uri:
    url: "http://{{ es_network_host }}:{{ es_proxy_settings.http_port | default(9200) }}/_cluster/settings"
    method: PUT
    body_format: json
    body:
      persistent:
        xpack:
          watcher:
            enabled: "{{ es_watcher_enabled | lower }}"
    headers:
      Content-Type: "application/json"
    status_code: [200, 400]
  when: 
    - es_watcher_enabled
    - es_wait_for_cluster
  ignore_errors: true
  delegate_to: "{{ groups['elasticsearch_cluster'][0] | default(inventory_hostname) }}"
  run_once: true

- name: Configure Watcher encryption
  ansible.builtin.uri:
    url: "http://{{ es_network_host }}:{{ es_proxy_settings.http_port | default(9200) }}/_cluster/settings"
    method: PUT
    body_format: json
    body:
      persistent:
        xpack:
          watcher:
            encrypt_sensitive_data: "{{ es_watcher_encrypt_sensitive_data | lower }}"
    headers:
      Content-Type: "application/json"
    status_code: [200, 400]
  when: 
    - es_watcher_enabled
    - es_wait_for_cluster
  ignore_errors: true
  delegate_to: "{{ groups['elasticsearch_cluster'][0] | default(inventory_hostname) }}"
  run_once: true

- name: Create monitoring dashboard watches
  ansible.builtin.uri:
    url: "http://{{ es_network_host }}:{{ es_proxy_settings.http_port | default(9200) }}/_watcher/watch/{{ item.name }}"
    method: PUT
    body_format: json
    body: "{{ item.watch }}"
    headers:
      Content-Type: "application/json"
    status_code: [200, 201, 400]
  loop: "{{ es_monitoring_watches | default([]) }}"
  when: 
    - es_watcher_enabled
    - es_wait_for_cluster
  ignore_errors: true
  delegate_to: "{{ groups['elasticsearch_cluster'][0] | default(inventory_hostname) }}"
  run_once: true

- name: Configure cluster health monitoring
  ansible.builtin.template:
    src: health-watch.json.j2
    dest: /tmp/health-watch.json
    mode: '0644'
  when: es_watcher_enabled

- name: Install cluster health watch
  ansible.builtin.uri:
    url: "http://{{ es_network_host }}:{{ es_proxy_settings.http_port | default(9200) }}/_watcher/watch/cluster_health"
    method: PUT
    body: "{{ lookup('file', '/tmp/health-watch.json') | from_json }}"
    body_format: json
    headers:
      Content-Type: "application/json"
    status_code: [200, 201, 400]
  when: 
    - es_watcher_enabled
    - es_wait_for_cluster
  ignore_errors: true
  delegate_to: "{{ groups['elasticsearch_cluster'][0] | default(inventory_hostname) }}"
  run_once: true

- name: Configure slow log monitoring
  ansible.builtin.lineinfile:
    path: /etc/elasticsearch/log4j2.properties
    regexp: '^logger\.slowlog\.'
    line: |
      logger.slowlog.name = index.search.slowlog
      logger.slowlog.level = warn
      logger.slowlog.appenderRef.slowlog_rolling.ref = slowlog_rolling
    create: true
  notify: restart elasticsearch

- name: Setup log rotation for monitoring logs
  ansible.builtin.template:
    src: elasticsearch-monitoring-logrotate.j2
    dest: /etc/logrotate.d/elasticsearch-monitoring
    owner: root
    group: root
    mode: '0644'
  when: es_enable_monitoring
