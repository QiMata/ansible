#!/bin/bash
# Elasticsearch Manual Snapshot Script
# Generated by Ansible

ES_HOST="{{ elasticsearch_network_host }}:{{ elasticsearch_proxy_settings.http_port | default(9200) }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

if [ $# -lt 1 ]; then
    echo "Usage: $0 <repository_name> [snapshot_name] [indices]"
    echo "Available repositories:"
{% for repo in elasticsearch_snapshot_repositories %}
    echo "  - {{ repo.name }}"
{% endfor %}
    exit 1
fi

REPOSITORY=$1
SNAPSHOT_NAME=${2:-"manual-snapshot-$TIMESTAMP"}
INDICES=${3:-"*"}

echo "Creating snapshot '$SNAPSHOT_NAME' in repository '$REPOSITORY'"
echo "Indices: $INDICES"

curl -X PUT "http://${ES_HOST}/_snapshot/${REPOSITORY}/${SNAPSHOT_NAME}?wait_for_completion=false" \
-H 'Content-Type: application/json' \
-d "{
  \"indices\": \"$INDICES\",
  \"ignore_unavailable\": true,
  \"include_global_state\": false,
  \"metadata\": {
    \"taken_by\": \"manual\",
    \"taken_because\": \"manual backup\",
    \"timestamp\": \"$TIMESTAMP\"
  }
}"

echo -e "\nSnapshot creation initiated. Check status with:"
echo "curl \"http://${ES_HOST}/_snapshot/${REPOSITORY}/${SNAPSHOT_NAME}\""
