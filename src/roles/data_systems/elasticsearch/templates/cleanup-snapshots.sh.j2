#!/bin/bash
# Elasticsearch Snapshot Cleanup Script
# Generated by Ansible
# Removes snapshots older than {{ elasticsearch_backup_retention_days }} days

ES_HOST="{{ elasticsearch_network_host }}:{{ elasticsearch_proxy_settings.http_port | default(9200) }}"
RETENTION_DAYS={{ elasticsearch_backup_retention_days }}

{% for repo in elasticsearch_snapshot_repositories %}
echo "Cleaning up snapshots in repository: {{ repo.name }}"

# Get all snapshots older than retention period
curl -s "http://${ES_HOST}/_snapshot/{{ repo.name }}/_all" | \
jq -r --arg days "$RETENTION_DAYS" '.snapshots[] | 
  select(.start_time_in_millis < (now * 1000 - ($days | tonumber * 24 * 60 * 60 * 1000))) | 
  .snapshot' | \
while read snapshot; do
  if [ -n "$snapshot" ]; then
    echo "Deleting snapshot: $snapshot"
    curl -X DELETE "http://${ES_HOST}/_snapshot/{{ repo.name }}/$snapshot"
  fi
done
{% endfor %}

echo "Snapshot cleanup completed at $(date)"
