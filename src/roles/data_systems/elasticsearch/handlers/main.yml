---
# ============================================================================
# ELASTICSEARCH HANDLERS
# ============================================================================

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true

- name: Restart Elasticsearch
  ansible.builtin.service:
    name: elasticsearch
    state: restarted
    enabled: true
  notify: Wait for Elasticsearch

- name: Reload Elasticsearch
  ansible.builtin.service:
    name: elasticsearch
    state: reloaded

- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: true

- name: Wait for Elasticsearch
  ansible.builtin.uri:
    url: "http://{{ elasticsearch_network_host }}:{{ elasticsearch_proxy_settings.http_port | default(9200) }}"
    method: GET
    status_code: [200, 401]
  register: elasticsearch_wait
  until: elasticsearch_wait.status in [200, 401]
  retries: 30
  delay: 10

- name: Validate cluster health
  ansible.builtin.uri:
    url: "http://{{ elasticsearch_network_host }}:{{ elasticsearch_proxy_settings.http_port | default(9200) }}/_cluster/health"
    method: GET
  register: cluster_health_check
  until: cluster_health_check.json.status != "red"
  retries: 10
  delay: 30
  when: elasticsearch_validate_cluster_health

- name: Reload elasticsearch config
  ansible.builtin.uri:
    url: "http://{{ elasticsearch_network_host }}:{{ elasticsearch_proxy_settings.http_port | default(9200) }}/_nodes/reload_secure_settings"
    method: POST
    body_format: json
    body: {}
    headers:
      Content-Type: "application/json"
    status_code: [200, 400]
  register: elasticsearch_reload_settings
  failed_when: elasticsearch_reload_settings.status not in [200, 400]
  changed_when: elasticsearch_reload_settings.status == 200

- name: Update elasticsearch passwords
  ansible.builtin.command:
    cmd: /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto --batch
  register: elasticsearch_password_setup
  changed_when: elasticsearch_password_setup.rc == 0
  failed_when: elasticsearch_password_setup.rc not in [0, 70]
  when: elasticsearch_enable_security

- name: Backup elasticsearch data
  vars:
    elasticsearch_snapshot_base_url: >-
      http://{{ elasticsearch_network_host }}:{{ elasticsearch_proxy_settings.http_port | default(9200) }}
  ansible.builtin.uri:
    url: "{{ elasticsearch_snapshot_base_url }}/_snapshot/backup-repo/automated-backup-{{ ansible_date_time.epoch }}"
    method: PUT
    body_format: json
    body:
      indices: "*"
      ignore_unavailable: true
      include_global_state: false
    headers:
      Content-Type: "application/json"
    status_code: [200, 201, 400]
  when:
    - elasticsearch_snapshot_repositories | length > 0
    - elasticsearch_backup_before_upgrade
  register: elasticsearch_backup_request
  failed_when: elasticsearch_backup_request.status not in [200, 201, 400]
  changed_when: elasticsearch_backup_request.status in [200, 201]
