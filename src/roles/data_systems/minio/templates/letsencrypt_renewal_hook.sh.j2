#!/bin/bash
# Let's Encrypt renewal hook for MinIO
# Generated by Ansible - do not edit manually

set -euo pipefail

MINIO_CERTS_DIR="{{ minio_certs_dir }}"
RENEWED_DOMAINS="{{ minio_letsencrypt_domains | join(' ') }}"

# Copy renewed certificates
for domain in $RENEWED_DOMAINS; do
    if [[ "$RENEWED_LINEAGE" == "/etc/letsencrypt/live/$domain" ]]; then
        echo "Updating MinIO certificates for domain: $domain"
        
        # Copy new certificates
        cp "$RENEWED_LINEAGE/fullchain.pem" "$MINIO_CERTS_DIR/public.crt"
        cp "$RENEWED_LINEAGE/privkey.pem" "$MINIO_CERTS_DIR/private.key"
        
        # Set proper ownership and permissions
        chown {{ minio_user }}:{{ minio_group }} "$MINIO_CERTS_DIR/public.crt" "$MINIO_CERTS_DIR/private.key"
        chmod 644 "$MINIO_CERTS_DIR/public.crt"
        chmod 600 "$MINIO_CERTS_DIR/private.key"
        
        # Restart MinIO service
        systemctl restart minio
        
        echo "MinIO certificates updated and service restarted"
        break
    fi
done
