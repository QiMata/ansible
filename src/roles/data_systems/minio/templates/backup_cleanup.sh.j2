#!/bin/bash
# MinIO Backup Cleanup Script
# Generated by Ansible - do not edit manually

set -euo pipefail

BACKUP_DIR="{{ minio_base_dir }}/backups"
RETENTION_DAYS={{ minio_backup_retention_days }}
LOGFILE="$BACKUP_DIR/cleanup.log"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOGFILE"
}

# Main cleanup function
main() {
    log_message "Starting backup cleanup process"
    
    if [[ ! -d "$BACKUP_DIR" ]]; then
        log_message "Backup directory does not exist: $BACKUP_DIR"
        exit 0
    fi
    
    # Find and remove old backup files
    local deleted_count=0
    
    while IFS= read -r -d '' file; do
        log_message "Removing old backup: $(basename "$file")"
        rm -f "$file"
        ((deleted_count++))
    done < <(find "$BACKUP_DIR" -name "*.tar.gz" -type f -mtime +$RETENTION_DAYS -print0 2>/dev/null)
    
    # Remove old log files
    find "$BACKUP_DIR" -name "*.log" -type f -mtime +$RETENTION_DAYS -delete 2>/dev/null || true
    
    # Remove old manifest files
    find "$BACKUP_DIR" -name "manifest_*.txt" -type f -mtime +$RETENTION_DAYS -delete 2>/dev/null || true
    
    log_message "Backup cleanup completed. Removed $deleted_count old backup files."
}

main "$@"
