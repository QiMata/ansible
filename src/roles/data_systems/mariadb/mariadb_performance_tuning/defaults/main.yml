---
# MariaDB Performance Tuning Role Default Variables

# Memory-based calculations (percentage of total RAM)
mariadb_innodb_buffer_pool_ratio: 0.7  # 70% of total RAM for InnoDB buffer pool
mariadb_key_buffer_ratio: 0.1          # 10% for MyISAM key buffer
mariadb_query_cache_ratio: 0.05        # 5% for query cache

# InnoDB Configuration
mariadb_innodb_buffer_pool_size: "{{ (ansible_memtotal_mb * mariadb_innodb_buffer_pool_ratio) | round | int }}M"
mariadb_innodb_buffer_pool_instances: "{{ [ansible_processor_vcpus, 8] | min }}"
mariadb_innodb_log_file_size: "256M"
mariadb_innodb_log_buffer_size: "16M"
mariadb_innodb_flush_log_at_trx_commit: 1
mariadb_innodb_flush_method: "O_DIRECT"
mariadb_innodb_file_per_table: true
mariadb_innodb_read_io_threads: 8
mariadb_innodb_write_io_threads: 8
mariadb_innodb_thread_concurrency: 0
mariadb_innodb_lock_wait_timeout: 120
mariadb_innodb_rollback_on_timeout: true
mariadb_innodb_print_all_deadlocks: true
mariadb_innodb_adaptive_hash_index: true
mariadb_innodb_change_buffering: "inserts"
mariadb_innodb_old_blocks_time: 1000
mariadb_innodb_stats_on_metadata: false

# Query Cache Configuration
mariadb_query_cache_enabled: true
mariadb_query_cache_type: 1
mariadb_query_cache_size: "{{ (ansible_memtotal_mb * mariadb_query_cache_ratio) | round | int }}M"
mariadb_query_cache_limit: "2M"
mariadb_query_cache_min_res_unit: "4K"

# MyISAM Configuration
mariadb_key_buffer_size: "{{ (ansible_memtotal_mb * mariadb_key_buffer_ratio) | round | int }}M"
mariadb_myisam_sort_buffer_size: "128M"
mariadb_myisam_max_sort_file_size: "2G"
mariadb_myisam_repair_threads: 1

# Connection and Thread Configuration
mariadb_max_connections: 200
mariadb_max_user_connections: 50
mariadb_thread_cache_size: "{{ [ansible_processor_vcpus * 2, 100] | min }}"
mariadb_thread_stack: "256K"
mariadb_thread_handling: "pool-of-threads"
mariadb_thread_pool_size: "{{ ansible_processor_vcpus }}"
mariadb_thread_pool_max_threads: 500

# Buffer and Cache Sizes
mariadb_sort_buffer_size: "2M"
mariadb_read_buffer_size: "128K"
mariadb_read_rnd_buffer_size: "256K"
mariadb_join_buffer_size: "256K"
mariadb_table_open_cache: 4000
mariadb_table_definition_cache: 1400

# Network and Timeout Configuration
mariadb_max_allowed_packet: "16M"
mariadb_connect_timeout: 10
mariadb_wait_timeout: 300
mariadb_interactive_timeout: 300
mariadb_net_read_timeout: 30
mariadb_net_write_timeout: 60

# Logging Configuration
mariadb_slow_query_log_enabled: true
mariadb_slow_query_log_file: "/var/log/mysql/slow.log"
mariadb_long_query_time: 2
mariadb_log_queries_not_using_indexes: true
mariadb_log_slow_admin_statements: true
mariadb_log_slow_slave_statements: true
mariadb_min_examined_row_limit: 100

# Performance Schema Configuration
mariadb_performance_schema_enabled: true
mariadb_performance_schema_max_memory: "{{ (ansible_memtotal_mb * 0.1) | round | int }}M"
mariadb_performance_schema_digests_size: 10000
mariadb_performance_schema_events_statements_history_size: 10
mariadb_performance_schema_events_statements_history_long_size: 10000

# Binary Logging (for replication and PITR)
mariadb_binlog_enabled: true
mariadb_binlog_format: "ROW"
mariadb_binlog_expire_logs_days: 7
mariadb_max_binlog_size: "1G"
mariadb_sync_binlog: 1
mariadb_binlog_cache_size: "32K"
mariadb_binlog_stmt_cache_size: "32K"

# Temporary Tables and Files
mariadb_tmp_table_size: "32M"
mariadb_max_heap_table_size: "32M"
mariadb_tmpdir: "/tmp"

# Galera-specific Performance Settings
mariadb_galera_performance_enabled: false
mariadb_wsrep_slave_threads: "{{ ansible_processor_vcpus }}"
mariadb_wsrep_certify_nonPK: true
mariadb_wsrep_max_ws_rows: 0
mariadb_wsrep_max_ws_size: "2G"
mariadb_wsrep_replicate_myisam: false

# Connection Pooling (ProxySQL integration)
mariadb_connection_pooling_enabled: false
mariadb_proxysql_monitor_username: "monitor"
mariadb_proxysql_monitor_password: "monitor"

# Advanced Performance Options
mariadb_optimizer_search_depth: 62
mariadb_optimizer_prune_level: 1
mariadb_optimizer_switch: "index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,subquery_materialization_cost_based=on,use_index_extensions=on"

# File System Level Optimizations
mariadb_fs_optimizations_enabled: false
mariadb_mount_options: "noatime,nodiratime"
