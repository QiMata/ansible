#!/bin/bash
# ============================================================================
# MariaDB Backup Script
# Generated by Ansible - {{ ansible_date_time.iso8601 }}
# ============================================================================

# Configuration
MYSQL_USER="root"
MYSQL_PASSWORD="{{ mariadb_root_password }}"
BACKUP_DIR="{{ mariadb_backup_dir }}"
RETENTION_DAYS="{{ mariadb_backup_retention_days }}"
TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
BACKUP_FILE="mariadb_backup_$TIMESTAMP.sql"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Perform backup
echo "Starting MariaDB backup at $(date)"
mysqldump -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" --all-databases --single-transaction --routines --triggers > "$BACKUP_DIR/$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "Backup completed successfully: $BACKUP_DIR/$BACKUP_FILE"
    gzip "$BACKUP_DIR/$BACKUP_FILE"
    echo "Backup compressed: $BACKUP_DIR/$BACKUP_FILE.gz"
else
    echo "Backup failed!"
    exit 1
fi

# Clean up old backups
find "$BACKUP_DIR" -name "mariadb_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete
echo "Old backups cleaned up (older than $RETENTION_DAYS days)"

echo "Backup process completed at $(date)"
