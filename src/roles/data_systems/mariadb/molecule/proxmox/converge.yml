---
- name: Converge
  hosts: all
  become: true
  gather_facts: true
  vars:
    # Override defaults for testing environment
    mariadb_root_password: "{{ mariadb_root_password | default('test_password_123') }}"
    mariadb_bind_address: "{{ mariadb_bind_address | default('0.0.0.0') }}"
    mariadb_port: "{{ mariadb_port | default(3306) }}"
    mariadb_environment: "{{ mariadb_environment | default('test') }}"

    # Container-aware performance settings
    mariadb_max_connections: "{{ mariadb_max_connections | default(50) }}"
    mariadb_innodb_buffer_pool_size: "{{ mariadb_innodb_buffer_pool_size | default('128M') }}"
    mariadb_query_cache_size: "{{ mariadb_query_cache_size | default('32M') }}"

    # Test database configuration
    mariadb_create_test_db: "{{ mariadb_create_test_db | default(true) }}"
    mariadb_test_db_name: "{{ mariadb_test_db_name | default('test_database') }}"
    mariadb_test_user: "{{ mariadb_test_user | default('test_user') }}"
    mariadb_test_password: "{{ mariadb_test_password | default('test_user_pass') }}"

    # Security settings for testing
    mariadb_enable_security: "{{ mariadb_enable_security | default(false) }}"
    mariadb_remove_anonymous_users: true
    mariadb_remove_test_database: false
    mariadb_disallow_root_login_remotely: false

    # Health check configuration
    mariadb_health_check_enabled: "{{ mariadb_health_check_enabled | default(true) }}"
    mariadb_health_check_retries: "{{ mariadb_health_check_retries | default(30) }}"
    mariadb_health_check_delay: "{{ mariadb_health_check_delay | default(5) }}"

  pre_tasks:
    # Container-specific preparations
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages for testing
      ansible.builtin.package:
        name:
          - python3-pymysql
          - mysql-client
        state: present

  tasks:
    - name: "Include mariadb role"
      ansible.builtin.include_role:
        name: mariadb

  post_tasks:
    # Create test database and user for validation
    - name: Create test database
      community.mysql.mysql_db:
        name: "{{ mariadb_test_db_name }}"
        state: present
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_host: localhost
      when: mariadb_create_test_db

    - name: Create test user
      community.mysql.mysql_user:
        name: "{{ mariadb_test_user }}"
        password: "{{ mariadb_test_password }}"
        priv: "{{ mariadb_test_db_name }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_host: localhost
      when: mariadb_create_test_db

  handlers:
    - name: restart mariadb
      ansible.builtin.service:
        name: mariadb
        state: restarted
        enabled: true

    - name: wait for mariadb
      ansible.builtin.wait_for:
        port: "{{ mariadb_port }}"
        host: "{{ mariadb_bind_address }}"
        delay: 5
        timeout: 300

    - name: reload mariadb
      ansible.builtin.service:
        name: mariadb
        state: reloaded
