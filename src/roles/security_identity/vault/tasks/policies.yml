---
# Policies configuration

- name: Wait for Vault to be ready
  ansible.builtin.uri:
    url: "http://{{ vault_addr }}:{{ vault_port }}/v1/sys/health"
    method: GET
    status_code: [200, 429, 501, 503]
  register: vault_health_check
  until: vault_health_check.status in [200, 429, 501, 503]
  retries: 30
  delay: 5

- name: Check if Vault is initialized
  ansible.builtin.uri:
    url: "http://{{ vault_addr }}:{{ vault_port }}/v1/sys/init"
    method: GET
    status_code: [200, 204, 404]
  register: vault_init_status

- name: Create policy files directory
  ansible.builtin.file:
    path: "{{ vault_config_dir }}/policies"
    state: directory
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0750"

- name: Write policy files
  ansible.builtin.copy:
    content: "{{ item.policy }}"
    dest: "{{ vault_config_dir }}/policies/{{ item.name }}.hcl"
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0644"
  loop: "{{ vault_policies }}"

- name: Create policies in Vault
  ansible.builtin.uri:
    url: "http://{{ vault_addr }}:{{ vault_port }}/v1/sys/policies/acl/{{ item.name }}"
    method: PUT
    headers:
      X-Vault-Token: "{{ vault_root_token | default('') }}"
    body_format: json
    body:
      policy: "{{ item.policy }}"
    status_code: [200, 204, 400]
  loop: "{{ vault_policies }}"
  when:
    - vault_init_status.json.initialized | default(false)
    - vault_root_token is defined

- name: Create default admin policy
  ansible.builtin.uri:
    url: "http://{{ vault_addr }}:{{ vault_port }}/v1/sys/policies/acl/admin"
    method: PUT
    headers:
      X-Vault-Token: "{{ vault_root_token | default('') }}"
    body_format: json
    body:
      policy: |
        # Admin policy - full access
        path "*" {
          capabilities = ["create", "read", "update", "delete", "list", "sudo"]
        }
    status_code: [200, 204, 400]
  when:
    - vault_init_status.json.initialized | default(false)
    - vault_root_token is defined
    - vault_policies | selectattr('name', 'equalto', 'admin') | list | length == 0

- name: Create default read-only policy
  ansible.builtin.uri:
    url: "http://{{ vault_addr }}:{{ vault_port }}/v1/sys/policies/acl/readonly"
    method: PUT
    headers:
      X-Vault-Token: "{{ vault_root_token | default('') }}"
    body_format: json
    body:
      policy: |
        # Read-only policy
        path "secret/data/*" {
          capabilities = ["read", "list"]
        }
        path "secret/metadata/*" {
          capabilities = ["read", "list"]
        }
    status_code: [200, 204, 400]
  when:
    - vault_init_status.json.initialized | default(false)
    - vault_root_token is defined
    - vault_policies | selectattr('name', 'equalto', 'readonly') | list | length == 0
