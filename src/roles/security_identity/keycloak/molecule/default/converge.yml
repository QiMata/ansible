---
- name: Converge
  hosts: all
  become: true
  pre_tasks:
    - name: Install PostgreSQL and dependencies
      ansible.builtin.apt:
        name:
          - postgresql
          - postgresql-client
          - python3-psycopg2
        state: present
        update_cache: true

    - name: Start PostgreSQL
      ansible.builtin.service:
        name: postgresql
        state: started
        enabled: true

    - name: Create database
      become: true
      become_user: postgres
      community.postgresql.postgresql_db:
        name: keycloak

    - name: Create user
      become: true
      become_user: postgres
      community.postgresql.postgresql_user:
        name: keycloak
        password: keycloak

  roles:
    - role: keycloak
      vars:
        # Basic configuration
        keycloak_db_host: localhost
        keycloak_db_name: keycloak
        keycloak_db_user: keycloak
        keycloak_db_password: keycloak
        keycloak_hostname: localhost

        # Admin user
        keycloak_create_admin: true
        keycloak_admin_user: admin
        keycloak_admin_password: admin123

        # Monitoring and logging
        keycloak_monitoring_enabled: true
        keycloak_metrics_enabled: true
        keycloak_log_level: INFO

        # Backup
        keycloak_backup_enabled: true
        keycloak_backup_retention_days: 3

        # Development features
        keycloak_dev_mode: true
        keycloak_create_test_realm: true

        # Configuration validation
        keycloak_validate_config: true
        keycloak_preflight_checks: true

        # Version management
        keycloak_cleanup_old_versions: false

        # Resource management
        keycloak_jvm_heap_min: "256m"
        keycloak_jvm_heap_max: "512m"
