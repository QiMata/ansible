---
# Admin user creation tasks
- name: Wait for Keycloak to be ready
  ansible.builtin.uri:
    url: "http://{{ keycloak_hostname }}:{{ keycloak_http_port }}/health/ready"
    method: GET
  register: keycloak_health
  until: keycloak_health.status == 200
  retries: 30
  delay: 10

- name: Check if admin user already exists
  ansible.builtin.command:
    cmd: >
      {{ keycloak_install_dir }}/bin/kcadm.sh get users
      --server http://{{ keycloak_hostname }}:{{ keycloak_http_port }}
      --realm master
      --user {{ keycloak_admin_user }}
      --password {{ keycloak_admin_password }}
  register: admin_check
  failed_when: false
  changed_when: false
  become_user: "{{ keycloak_user }}"

- name: Create initial admin user
  ansible.builtin.command:
    cmd: >
      {{ keycloak_install_dir }}/bin/kcadm.sh create users
      --server http://{{ keycloak_hostname }}:{{ keycloak_http_port }}
      --realm master
      --user {{ keycloak_admin_user }}
      --password {{ keycloak_admin_password }}
      -s username={{ keycloak_admin_user }}
      -s enabled=true
      -s emailVerified=true
  become_user: "{{ keycloak_user }}"
  when: admin_check.rc != 0

- name: Set admin user password
  ansible.builtin.command:
    cmd: >
      {{ keycloak_install_dir }}/bin/kcadm.sh set-password
      --server http://{{ keycloak_hostname }}:{{ keycloak_http_port }}
      --realm master
      --user {{ keycloak_admin_user }}
      --password {{ keycloak_admin_password }}
      --username {{ keycloak_admin_user }}
      --new-password {{ keycloak_admin_password }}
  become_user: "{{ keycloak_user }}"
  when: admin_check.rc != 0

- name: Verify admin user creation
  ansible.builtin.command:
    cmd: >
      {{ keycloak_install_dir }}/bin/kcadm.sh get users
      --server http://{{ keycloak_hostname }}:{{ keycloak_http_port }}
      --realm master
      --user {{ keycloak_admin_user }}
      --password {{ keycloak_admin_password }}
  register: admin_verify
  become_user: "{{ keycloak_user }}"

- name: Display admin user creation result
  ansible.builtin.debug:
    msg: "Admin user {{ keycloak_admin_user }} created successfully"
  when: admin_verify.rc == 0
