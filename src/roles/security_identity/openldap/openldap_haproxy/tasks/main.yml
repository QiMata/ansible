---
- name: Install HAProxy and dependencies
  ansible.builtin.package:
    name:
      - haproxy
      - rsyslog
      - openssl
    state: present
  become: true
  when: security_identity_openldap_haproxy_enabled

- name: Create HAProxy configuration directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  loop:
    - /etc/haproxy/conf.d
    - /var/log/haproxy
    - /etc/ssl/haproxy
  when: security_identity_openldap_haproxy_enabled

- name: Configure HAProxy for OpenLDAP
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    owner: root
    group: root
    mode: '0644'
    backup: true
  become: true
  notify: Restart HAProxy
  when: security_identity_openldap_haproxy_enabled

- name: Configure HAProxy logging
  ansible.builtin.include_tasks: logging.yml
  when:
    - security_identity_openldap_haproxy_enabled
    - security_identity_openldap_haproxy_logging_enabled

- name: Setup SSL/TLS for HAProxy
  ansible.builtin.include_tasks: ssl.yml
  when:
    - security_identity_openldap_haproxy_enabled
    - security_identity_openldap_haproxy_ssl_enabled

- name: Configure LDAP health checks
  ansible.builtin.include_tasks: health_checks.yml
  when:
    - security_identity_openldap_haproxy_enabled
    - security_identity_openldap_haproxy_health_check_enabled

- name: Setup HAProxy monitoring
  ansible.builtin.include_tasks: monitoring.yml
  when:
    - security_identity_openldap_haproxy_enabled
    - security_identity_openldap_haproxy_prometheus_enabled

- name: Start and enable HAProxy
  ansible.builtin.service:
    name: haproxy
    state: started
    enabled: true
  become: true
  when: security_identity_openldap_haproxy_enabled

- name: Verify HAProxy configuration
  ansible.builtin.command: haproxy -c -f /etc/haproxy/haproxy.cfg
  become: true
  register: haproxy_config_check
  failed_when: haproxy_config_check.rc != 0
  changed_when: false
  when: security_identity_openldap_haproxy_enabled
