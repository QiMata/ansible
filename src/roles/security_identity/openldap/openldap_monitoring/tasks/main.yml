---
- name: Install monitoring dependencies
  ansible.builtin.package:
    name:
      - python3-prometheus-client
      - python3-psutil
      - python3-ldap3
      - curl
      - jq
    state: present
  become: true
  when: security_identity_openldap_monitoring_enabled

- name: Create monitoring directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: openldap
    group: openldap
    mode: "0755"
  become: true
  loop:
    - /etc/openldap/monitoring
    - /var/lib/openldap/monitoring
    - /var/log/openldap/monitoring
    - /usr/local/bin/openldap-monitoring
  when: security_identity_openldap_monitoring_enabled

- name: Setup Prometheus monitoring
  ansible.builtin.include_tasks: prometheus.yml
  when:
    - security_identity_openldap_monitoring_enabled
    - security_identity_openldap_monitoring_prometheus_enabled

- name: Configure health checks
  ansible.builtin.include_tasks: health_checks.yml
  when:
    - security_identity_openldap_monitoring_enabled
    - security_identity_openldap_monitoring_health_checks_enabled

- name: Setup Grafana dashboards
  ansible.builtin.include_tasks: grafana.yml
  when:
    - security_identity_openldap_monitoring_enabled
    - security_identity_openldap_monitoring_grafana_enabled

- name: Configure alerting
  ansible.builtin.include_tasks: alerting.yml
  when:
    - security_identity_openldap_monitoring_enabled
    - security_identity_openldap_monitoring_alerting_enabled

- name: Setup performance monitoring
  ansible.builtin.include_tasks: performance.yml
  when:
    - security_identity_openldap_monitoring_enabled
    - security_identity_openldap_monitoring_metrics_enabled

- name: Configure capacity monitoring
  ansible.builtin.include_tasks: capacity.yml
  when:
    - security_identity_openldap_monitoring_enabled
    - security_identity_openldap_monitoring_capacity_monitoring

- name: Setup custom monitoring scripts
  ansible.builtin.include_tasks: custom_scripts.yml
  when:
    - security_identity_openldap_monitoring_enabled
    - security_identity_openldap_monitoring_custom_scripts | length > 0

- name: Create monitoring service files
  ansible.builtin.include_tasks: services.yml
  when: security_identity_openldap_monitoring_enabled
