---
- name: Fail if domains are not set
  ansible.builtin.fail:
    msg: "security_identity_letsencrypt_godaddy_cert_domains must contain at least one domain"
  when: __letsencrypt_godaddy_cert_domains | length == 0

- name: Set ACME CA flag
  ansible.builtin.set_fact:
    acme_ca_flag: "{{ '--staging' if __letsencrypt_godaddy_use_staging else '' }}"

- name: Issue or renew certificate
  ansible.builtin.shell: |
    export GD_Key="{{ __letsencrypt_godaddy_api_key }}";
    export GD_Secret="{{ __letsencrypt_godaddy_api_secret }}";
    "{{ __letsencrypt_godaddy_acme_sh_install_dir }}/acme.sh" --issue \
      --dns dns_gd \
      {% for domain in __letsencrypt_godaddy_cert_domains %}-d {{ domain }} {% endfor %} \
      --dnssleep {{ __letsencrypt_godaddy_propagation_wait }} \
      {{ acme_ca_flag }} \
      {% if __letsencrypt_godaddy_account_email %}--accountemail "{{ __letsencrypt_godaddy_account_email }}"{% endif %} \
      {% if __letsencrypt_godaddy_force_renew %}--force{% endif %} \
      --home "{{ __letsencrypt_godaddy_acme_sh_install_dir }}" \
      --config-home "{{ __letsencrypt_godaddy_acme_sh_install_dir }}"
  environment:
    GD_Key: "{{ __letsencrypt_godaddy_api_key }}"
    GD_Secret: "{{ __letsencrypt_godaddy_api_secret }}"
  register: acme_issue
  changed_when: "'Cert success' in acme_issue.stdout or 'Cert success' in acme_issue.stderr"
  no_log: true
  become: true
