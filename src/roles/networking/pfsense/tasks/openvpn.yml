---
# OpenVPN Configuration
- name: Configure OpenVPN servers
  pfsense_openvpn_server:  # noqa: syntax-check[unknown-module]
    mode: "{{ item.mode | default('server_user') }}"
    protocol: "{{ item.protocol | default('udp4') }}"
    interface: "{{ item.interface }}"
    local_port: "{{ item.local_port | default(1194) }}"
    description: "{{ item.descr | default(omit) }}"
    caref: "{{ item.caref }}"
    crtref: "{{ item.crtref }}"
    dh_length: "{{ item.dh_length | default(2048) }}"
    ecdh_curve: "{{ item.ecdh_curve | default('prime256v1') }}"
    cert_depth: "{{ item.cert_depth | default(1) }}"
    strictusercn: "{{ item.strictusercn | default(false) }}"
    tunnel_network: "{{ item.tunnel_network }}"
    tunnel_networkv6: "{{ item.tunnel_networkv6 | default(omit) }}"
    remote_network: "{{ item.remote_network | default(omit) }}"
    remote_networkv6: "{{ item.remote_networkv6 | default(omit) }}"
    gwredir: "{{ item.gwredir | default(false) }}"
    local_network: "{{ item.local_network | default(omit) }}"
    local_networkv6: "{{ item.local_networkv6 | default(omit) }}"
    maxclients: "{{ item.maxclients | default(omit) }}"
    compression: "{{ item.compression | default('adaptive') }}"
    duplicate_cn: "{{ item.duplicate_cn | default(false) }}"
    dynamic_ip: "{{ item.dynamic_ip | default(false) }}"
    topology: "{{ item.topology | default('net30') }}"
    dns_server_enable: "{{ item.dns_server_enable | default(false) }}"
    dns_server1: "{{ item.dns_server1 | default(omit) }}"
    dns_server2: "{{ item.dns_server2 | default(omit) }}"
    dns_server3: "{{ item.dns_server3 | default(omit) }}"
    dns_server4: "{{ item.dns_server4 | default(omit) }}"
    push_blockoutsidedns: "{{ item.push_blockoutsidedns | default(false) }}"
    push_register_dns: "{{ item.push_register_dns | default(false) }}"
    ntp_server_enable: "{{ item.ntp_server_enable | default(false) }}"
    ntp_server1: "{{ item.ntp_server1 | default(omit) }}"
    ntp_server2: "{{ item.ntp_server2 | default(omit) }}"
    netbios_enable: "{{ item.netbios_enable | default(false) }}"
    netbios_ntype: "{{ item.netbios_ntype | default(omit) }}"
    netbios_scope: "{{ item.netbios_scope | default(omit) }}"
    wins_server_enable: "{{ item.wins_server_enable | default(false) }}"
    wins_server1: "{{ item.wins_server1 | default(omit) }}"
    wins_server2: "{{ item.wins_server2 | default(omit) }}"
    client2client: "{{ item.client2client | default(false) }}"
    custom_options: "{{ item.custom_options | default(omit) }}"
    verbosity_level: "{{ item.verbosity_level | default(1) }}"
    state: present
  loop: "{{ pfsense_openvpn.servers | default([]) }}"
  when: pfsense_openvpn.servers is defined
  notify: restart openvpn

- name: Configure OpenVPN clients
  pfsense_openvpn_client:  # noqa: syntax-check[unknown-module]
    mode: "{{ item.mode | default('p2p_tls') }}"
    protocol: "{{ item.protocol | default('udp4') }}"
    interface: "{{ item.interface }}"
    server_addr: "{{ item.server_addr }}"
    server_port: "{{ item.server_port | default(1194) }}"
    proxy_addr: "{{ item.proxy_addr | default(omit) }}"
    proxy_port: "{{ item.proxy_port | default(omit) }}"
    proxy_user: "{{ item.proxy_user | default(omit) }}"
    proxy_passwd: "{{ item.proxy_passwd | default(omit) }}"
    proxy_authtype: "{{ item.proxy_authtype | default(omit) }}"
    description: "{{ item.descr | default(omit) }}"
    caref: "{{ item.caref }}"
    crtref: "{{ item.crtref | default(omit) }}"
    shared_key: "{{ item.shared_key | default(omit) }}"
    crypto: "{{ item.crypto | default('AES-256-CBC') }}"
    digest: "{{ item.digest | default('SHA256') }}"
    tunnel_network: "{{ item.tunnel_network | default(omit) }}"
    tunnel_networkv6: "{{ item.tunnel_networkv6 | default(omit) }}"
    remote_network: "{{ item.remote_network | default(omit) }}"
    remote_networkv6: "{{ item.remote_networkv6 | default(omit) }}"
    compression: "{{ item.compression | default('adaptive') }}"
    custom_options: "{{ item.custom_options | default(omit) }}"
    verbosity_level: "{{ item.verbosity_level | default(1) }}"
    state: present
  loop: "{{ pfsense_openvpn.clients | default([]) }}"
  when: pfsense_openvpn.clients is defined
  notify: restart openvpn

- name: Configure OpenVPN client-specific overrides
  pfsense_openvpn_override:  # noqa: syntax-check[unknown-module]
    server_id: "{{ item.0.vpnid | default(omit) }}"
    common_name: "{{ item.1.common_name }}"
    description: "{{ item.1.descr | default(omit) }}"
    tunnel_network: "{{ item.1.tunnel_network | default(omit) }}"
    local_network: "{{ item.1.local_network | default(omit) }}"
    remote_network: "{{ item.1.remote_network | default(omit) }}"
    gwredir: "{{ item.1.gwredir | default(false) }}"
    push_reset: "{{ item.1.push_reset | default(false) }}"
    remove_route: "{{ item.1.remove_route | default(false) }}"
    dns_domain: "{{ item.1.dns_domain | default(omit) }}"
    dns_server1: "{{ item.1.dns_server1 | default(omit) }}"
    dns_server2: "{{ item.1.dns_server2 | default(omit) }}"
    dns_server3: "{{ item.1.dns_server3 | default(omit) }}"
    dns_server4: "{{ item.1.dns_server4 | default(omit) }}"
    ntp_server1: "{{ item.1.ntp_server1 | default(omit) }}"
    ntp_server2: "{{ item.1.ntp_server2 | default(omit) }}"
    custom_options: "{{ item.1.custom_options | default(omit) }}"
    state: present
  loop: "{{ pfsense_openvpn.servers | subelements('client_overrides', skip_missing=True) }}"
  when: pfsense_openvpn.servers is defined
  notify: restart openvpn
