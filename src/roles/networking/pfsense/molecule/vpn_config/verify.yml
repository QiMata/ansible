---
- name: Verify VPN Configuration
  hosts: all
  gather_facts: false
  tasks:
    - name: Verify VPN system configuration
      assert:
        that:
          - pfsense_system_settings.hostname == "pfsense-vpn"
          - pfsense_system_settings.domain == "vpn.test"
        fail_msg: "VPN system settings verification failed"
        success_msg: "VPN system settings verified"

    - name: Verify certificate configuration
      assert:
        that:
          - pfsense_generated_certificates | length >= 2
          - pfsense_generated_certificates | selectattr('name', 'equalto', 'VPN_CA') | list | length == 1
          - pfsense_generated_certificates | selectattr('name', 'equalto', 'VPN_Server_Cert') | list | length == 1
        fail_msg: "Certificate configuration verification failed"
        success_msg: "Certificate configuration verified"

    - name: Verify OpenVPN server configuration
      assert:
        that:
          - pfsense_openvpn.servers | length >= 2
          - pfsense_openvpn.servers[0].descr == "Remote Access VPN Server"
          - pfsense_openvpn.servers[0].mode == "server_user"
          - pfsense_openvpn.servers[0].local_port == 1194
          - pfsense_openvpn.servers[0].tunnel_network == "10.8.0.0/24"
          - pfsense_openvpn.servers[1].descr == "Site-to-Site OpenVPN"
          - pfsense_openvpn.servers[1].mode == "p2p_tls"
          - pfsense_openvpn.servers[1].local_port == 1195
        fail_msg: "OpenVPN server configuration verification failed"
        success_msg: "OpenVPN server configuration verified"

    - name: Verify OpenVPN client configuration
      assert:
        that:
          - pfsense_openvpn.clients | length >= 1
          - pfsense_openvpn.clients[0].descr == "Branch Office VPN Client"
          - pfsense_openvpn.clients[0].mode == "p2p_tls"
          - pfsense_openvpn.clients[0].server_addr == "203.0.113.100"
        fail_msg: "OpenVPN client configuration verification failed"
        success_msg: "OpenVPN client configuration verified"

    - name: Verify IPsec configuration
      assert:
        that:
          - pfsense_ipsec.enable == true
          - pfsense_ipsec.phase1 | length >= 2
          - pfsense_ipsec.phase2 | length >= 2
        fail_msg: "IPsec configuration verification failed"
        success_msg: "IPsec configuration verified"

    - name: Verify IPsec Phase 1 configuration
      assert:
        that:
          - pfsense_ipsec.phase1[0].descr == "Site-to-Site IPsec VPN"
          - pfsense_ipsec.phase1[0].remote_gateway == "203.0.113.200"
          - pfsense_ipsec.phase1[0].iketype == "ikev2"
          - pfsense_ipsec.phase1[0].encryption == "aes256"
          - pfsense_ipsec.phase1[1].descr == "Mobile IPsec VPN"
          - pfsense_ipsec.phase1[1].authentication_method == "eap-mschapv2"
        fail_msg: "IPsec Phase 1 configuration verification failed"
        success_msg: "IPsec Phase 1 configuration verified"

    - name: Verify IPsec Phase 2 configuration
      assert:
        that:
          - pfsense_ipsec.phase2[0].descr == "Site-to-Site Tunnel"
          - pfsense_ipsec.phase2[0].localid_address == "192.168.1.0"
          - pfsense_ipsec.phase2[0].remoteid_address == "192.168.200.0"
          - pfsense_ipsec.phase2[1].descr == "Mobile IPsec Pool"
          - pfsense_ipsec.phase2[1].remoteid_address == "10.12.0.0"
        fail_msg: "IPsec Phase 2 configuration verification failed"
        success_msg: "IPsec Phase 2 configuration verified"

    - name: Verify VPN firewall rules
      assert:
        that:
          - pfsense_firewall_rules | length >= 10
          - pfsense_firewall_rules | selectattr('destination_port', 'equalto', '1194') | list | length >= 1
          - pfsense_firewall_rules | selectattr('destination_port', 'equalto', '1195') | list | length >= 1
          - pfsense_firewall_rules | selectattr('destination_port', 'equalto', '500') | list | length >= 1
          - pfsense_firewall_rules | selectattr('destination_port', 'equalto', '4500') | list | length >= 1
        fail_msg: "VPN firewall rules verification failed"
        success_msg: "VPN firewall rules verified"

    - name: Verify OpenVPN tunnel rules
      assert:
        that:
          - pfsense_firewall_rules | selectattr('source', 'equalto', '10.8.0.0/24') | list | length >= 1
          - pfsense_firewall_rules | selectattr('source', 'equalto', '10.9.0.0/30') | list | length >= 1
          - pfsense_firewall_rules | selectattr('interface', 'equalto', 'openvpn') | list | length >= 2
        fail_msg: "OpenVPN tunnel rules verification failed"
        success_msg: "OpenVPN tunnel rules verified"

    - name: Verify IPsec tunnel rules
      assert:
        that:
          - pfsense_firewall_rules | selectattr('source', 'equalto', '192.168.200.0/24') | list | length >= 1
          - pfsense_firewall_rules | selectattr('source', 'equalto', '10.12.0.0/24') | list | length >= 1
          - pfsense_firewall_rules | selectattr('interface', 'equalto', 'ipsec') | list | length >= 2
        fail_msg: "IPsec tunnel rules verification failed"
        success_msg: "IPsec tunnel rules verified"

    - name: Verify VPN NAT rules
      assert:
        that:
          - pfsense_nat_rules | length >= 2
          - pfsense_nat_rules | selectattr('local_port', 'equalto', '1194') | list | length >= 1
          - pfsense_nat_rules | selectattr('local_port', 'equalto', '1195') | list | length >= 1
        fail_msg: "VPN NAT rules verification failed"
        success_msg: "VPN NAT rules verified"

    - name: Verify all VPN features are enabled
      assert:
        that:
          - pfsense_configure_certificates == true
          - pfsense_configure_openvpn == true
          - pfsense_configure_ipsec == true
        fail_msg: "Not all VPN features are enabled"
        success_msg: "All VPN features are properly enabled"

    - name: Verify VPN network isolation
      assert:
        that:
          - pfsense_openvpn.servers[0].client2client == false
          - pfsense_openvpn.servers[0].duplicate_cn == false
        fail_msg: "VPN network isolation verification failed"
        success_msg: "VPN network isolation verified"
