---
- name: Converge
  hosts: all
  become: true
  gather_facts: true
  vars:
    # Basic NiFi settings for testing
    apache_nifi_version: "1.23.2"
    apache_nifi_home: "/opt/nifi"
    apache_nifi_user: "nifi"
    apache_nifi_group: "nifi"
    apache_nifi_service_enabled: false  # Don't start service in test
    apache_nifi_backup_enabled: false
    apache_nifi_auto_provision_users: false
  tasks:
    - name: "Install Java (OpenJDK 17)"
      ansible.builtin.apt:
        name: 
          - openjdk-17-jdk
          - unzip
        state: present
        update_cache: yes
        
    - name: "Create nifi group"
      ansible.builtin.group:
        name: "{{ apache_nifi_group }}"
        system: yes
        
    - name: "Create nifi user"
      ansible.builtin.user:
        name: "{{ apache_nifi_user }}"
        group: "{{ apache_nifi_group }}"
        system: yes
        shell: /bin/bash
        home: "{{ apache_nifi_home }}"
        createhome: no
        
    - name: "Create NiFi directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ apache_nifi_user }}"
        group: "{{ apache_nifi_group }}"
        mode: '0755'
      loop:
        - "{{ apache_nifi_home }}"
        - "{{ apache_nifi_home }}/conf"
        - "{{ apache_nifi_home }}/logs"
        
    - name: "Test Java installation"
      ansible.builtin.command: java -version
      register: java_version_result
      changed_when: false
      
    - name: "Display Java version"
      ansible.builtin.debug:
        var: java_version_result.stderr
        
    - name: "Test completed successfully"
      ansible.builtin.debug:
        msg: "âœ… Apache NiFi basic setup test completed successfully!"
