---
# Create Airflow connections

- name: Create Airflow connections
  ansible.builtin.command: >
    {{ airflow_binary_path }} connections add
    {{ item.conn_id }}
    --conn-type {{ item.conn_type }}
    {% if item.host is defined %}--conn-host {{ item.host }}{% endif %}
    {% if item.port is defined %}--conn-port {{ item.port }}{% endif %}
    {% if item.login is defined %}--conn-login {{ item.login }}{% endif %}
    {% if item.password is defined %}--conn-password {{ item.password }}{% endif %}
    {% if item.schema is defined %}--conn-schema {{ item.schema }}{% endif %}
    {% if item.extra is defined %}--conn-extra '{{ item.extra | to_json }}'{% endif %}
    {% if item.description is defined %}--conn-description "{{ item.description }}"{% endif %}
  environment:
    AIRFLOW_HOME: "{{ airflow_home }}"
  register: connection_result
  changed_when: "'successfully added' in connection_result.stdout"
  failed_when: 
    - connection_result.rc != 0
    - "'already exists' not in connection_result.stderr"
  loop: "{{ airflow_connections }}"
  loop_control:
    label: "{{ item.conn_id }}"

- name: Update existing Airflow connections
  ansible.builtin.command: >
    {{ airflow_binary_path }} connections add
    {{ item.conn_id }}
    --conn-type {{ item.conn_type }}
    {% if item.host is defined %}--conn-host {{ item.host }}{% endif %}
    {% if item.port is defined %}--conn-port {{ item.port }}{% endif %}
    {% if item.login is defined %}--conn-login {{ item.login }}{% endif %}
    {% if item.password is defined %}--conn-password {{ item.password }}{% endif %}
    {% if item.schema is defined %}--conn-schema {{ item.schema }}{% endif %}
    {% if item.extra is defined %}--conn-extra '{{ item.extra | to_json }}'{% endif %}
    {% if item.description is defined %}--conn-description "{{ item.description }}"{% endif %}
    --overwrite
  environment:
    AIRFLOW_HOME: "{{ airflow_home }}"
  when: 
    - item.update_existing is defined 
    - item.update_existing | bool
    - "'already exists' in connection_result.stderr"
  loop: "{{ airflow_connections }}"
  loop_control:
    label: "{{ item.conn_id }}"

- name: List created connections
  ansible.builtin.command: "{{ airflow_binary_path }} connections list --output table"
  environment:
    AIRFLOW_HOME: "{{ airflow_home }}"
  register: connections_list
  changed_when: false
  when: airflow_connector_list_connections | bool

- name: Display connections list
  ansible.builtin.debug:
    var: connections_list.stdout_lines
  when: 
    - airflow_connector_list_connections | bool
    - connections_list is defined
