---
# Health Checks and Monitoring Tasks
- name: Create systemd health check scripts directory
  ansible.builtin.file:
    path: "/opt/spark/scripts"
    state: directory
    owner: "{{ spark_role_user }}"
    group: "{{ spark_role_group }}"
    mode: '0755'

- name: Deploy health check script
  ansible.builtin.template:
    src: health_check.sh.j2
    dest: "/opt/spark/scripts/health_check.sh"
    owner: "{{ spark_role_user }}"
    group: "{{ spark_role_group }}"
    mode: '0755'
  when: spark_role_health_checks_enabled

- name: Download Prometheus JMX Exporter
  ansible.builtin.get_url:
    url: "https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/{{ spark_role_prometheus_jmx_exporter_version }}/jmx_prometheus_javaagent-{{ spark_role_prometheus_jmx_exporter_version }}.jar"
    dest: "/opt/spark/jars/jmx_prometheus_javaagent-{{ spark_role_prometheus_jmx_exporter_version }}.jar"
    owner: "{{ spark_role_user }}"
    group: "{{ spark_role_group }}"
    mode: '0644'
  when: spark_role_prometheus_enabled

- name: Deploy Prometheus JMX Exporter configuration
  ansible.builtin.template:
    src: jmx_prometheus_config.yml.j2
    dest: "/opt/spark/conf/jmx_prometheus_config.yml"
    owner: "{{ spark_role_user }}"
    group: "{{ spark_role_group }}"
    mode: '0644'
  when: spark_role_prometheus_enabled

- name: Install alerting dependencies
  ansible.builtin.apt:
    name:
      - mailutils
      - sendemail
    state: present
    update_cache: true
  when: spark_role_health_checks_enabled

- name: Deploy alerting script
  ansible.builtin.template:
    src: spark_alerting.sh.j2
    dest: "/opt/spark/scripts/spark_alerting.sh"
    owner: "{{ spark_role_user }}"
    group: "{{ spark_role_group }}"
    mode: '0755'
  when: spark_role_health_checks_enabled

- name: Create alerting cron job
  ansible.builtin.cron:
    name: "Spark health monitoring"
    minute: "*/5"
    job: "/opt/spark/scripts/spark_alerting.sh"
    user: "{{ spark_role_user }}"
  when: spark_role_health_checks_enabled
