---
# Security Enhancement Tasks

- name: Install firewall management tools
  ansible.builtin.apt:
    name: ufw
    state: present
  when: superset_firewall_enabled
  tags: ['superset', 'superset_security']

- name: Configure firewall rules for Superset
  community.general.ufw:
    rule: allow
    port: "{{ superset_gunicorn_bind.split(':')[1] }}"
    proto: tcp
    from_ip: "{{ item }}"
    comment: "Superset access from {{ item }}"
  loop: "{{ superset_firewall_allowed_ips }}"
  when:
    - superset_firewall_enabled
    - superset_firewall_allowed_ips | length > 0
  tags: ['superset', 'superset_security']

- name: Enable firewall
  community.general.ufw:
    state: enabled
    policy: deny
    direction: incoming
  when: superset_firewall_enabled
  tags: ['superset', 'superset_security']

- name: Install fail2ban
  ansible.builtin.apt:
    name: fail2ban
    state: present
  when: superset_fail2ban_enabled
  tags: ['superset', 'superset_security']

- name: Configure fail2ban for Superset
  ansible.builtin.template:
    src: fail2ban-superset.conf.j2
    dest: /etc/fail2ban/filter.d/superset.conf
    owner: root
    group: root
    mode: '0644'
  when: superset_fail2ban_enabled
  notify:
    - restart fail2ban
  tags: ['superset', 'superset_security']

- name: Configure fail2ban jail for Superset
  ansible.builtin.template:
    src: fail2ban-superset-jail.conf.j2
    dest: /etc/fail2ban/jail.d/superset.conf
    owner: root
    group: root
    mode: '0644'
  when: superset_fail2ban_enabled
  notify:
    - restart fail2ban
  tags: ['superset', 'superset_security']

- name: Enable and start fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  when: superset_fail2ban_enabled
  tags: ['superset', 'superset_security']

- name: Install rate limiting dependencies
  ansible.builtin.pip:
    name:
      - flask-limiter
      - redis
    virtualenv: "{{ superset_venv_dir }}"
    virtualenv_command: python3 -m venv
  when: superset_rate_limiting_enabled
  tags: ['superset', 'superset_security']

- name: Ensure Superset files have correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ superset_user }}"
    group: "{{ superset_group }}"
    mode: '0640'
    recurse: true
  loop:
    - "{{ superset_config_dir }}"
    - "{{ superset_install_dir }}"
  tags: ['superset', 'superset_security']

- name: Restrict access to config directory
  ansible.builtin.file:
    path: "{{ superset_config_dir }}"
    mode: '0750'
  tags: ['superset', 'superset_security']

- name: Display security configuration
  ansible.builtin.debug:
    msg:
      - "Firewall enabled: {{ superset_firewall_enabled }}"
      - "Fail2ban enabled: {{ superset_fail2ban_enabled }}"
      - "CSP enabled: {{ superset_csp_enabled }}"
      - "Rate limiting enabled: {{ superset_rate_limiting_enabled }}"
  tags: ['superset', 'superset_security']
