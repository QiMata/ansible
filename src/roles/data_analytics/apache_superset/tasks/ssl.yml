---
# SSL/TLS Configuration Tasks
# Note: For Let's Encrypt certificates, use the letsencrypt role instead

- name: Ensure SSL certificate directory exists
  ansible.builtin.file:
    path: "{{ item | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - "{{ superset_ssl_cert_path }}"
    - "{{ superset_ssl_key_path }}"
  tags: ['superset', 'superset_ssl']

- name: Check if SSL certificate exists
  ansible.builtin.stat:
    path: "{{ superset_ssl_cert_path }}"
  register: ssl_cert_stat
  tags: ['superset', 'superset_ssl']

- name: Check if SSL private key exists
  ansible.builtin.stat:
    path: "{{ superset_ssl_key_path }}"
  register: ssl_key_stat
  tags: ['superset', 'superset_ssl']

- name: Generate self-signed SSL certificate if none exists
  block:
    - name: Generate private key
      community.crypto.openssl_privatekey:
        path: "{{ superset_ssl_key_path }}"
        size: 2048
        owner: root
        group: "{{ superset_group }}"
        mode: '0640'

    - name: Generate certificate signing request
      community.crypto.openssl_csr:
        path: "/tmp/superset.csr"
        privatekey_path: "{{ superset_ssl_key_path }}"
        common_name: "{{ ansible_fqdn }}"
        subject_alt_name:
          - "DNS:{{ ansible_fqdn }}"
          - "DNS:{{ ansible_hostname }}"
          - "IP:{{ ansible_default_ipv4.address }}"

    - name: Generate self-signed certificate
      community.crypto.x509_certificate:
        path: "{{ superset_ssl_cert_path }}"
        privatekey_path: "{{ superset_ssl_key_path }}"
        csr_path: "/tmp/superset.csr"
        provider: selfsigned
        owner: root
        group: "{{ superset_group }}"
        mode: '0644'

    - name: Remove CSR file
      ansible.builtin.file:
        path: "/tmp/superset.csr"
        state: absent
  when: not ssl_cert_stat.stat.exists or not ssl_key_stat.stat.exists
  tags: ['superset', 'superset_ssl']

- name: Generate DH parameters if not exists
  community.crypto.openssl_dhparam:
    path: "{{ superset_ssl_dhparam_path }}"
    size: 2048
    owner: root
    group: root
    mode: '0644'
  when: superset_ssl_dhparam_path != ""
  tags: ['superset', 'superset_ssl']

- name: Validate SSL certificate
  community.crypto.x509_certificate_info:
    path: "{{ superset_ssl_cert_path }}"
  register: ssl_cert_info
  tags: ['superset', 'superset_ssl']

- name: Display SSL certificate information
  ansible.builtin.debug:
    msg: 
      - "SSL Certificate Subject: {{ ssl_cert_info.subject }}"
      - "SSL Certificate Valid From: {{ ssl_cert_info.not_before }}"
      - "SSL Certificate Valid Until: {{ ssl_cert_info.not_after }}"
  tags: ['superset', 'superset_ssl']
