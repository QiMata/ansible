#!/bin/bash
# Superset Configuration Backup Script

set -e

BACKUP_DIR="{{ superset_config_backup_path }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/superset_config_${TIMESTAMP}.tar.gz"

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

echo "Backing up Superset configuration at $(date)"

# Create configuration backup
tar -czf "${BACKUP_FILE}" \
  -C "{{ superset_config_dir | dirname }}" \
  "{{ superset_config_dir | basename }}" \
  --exclude='*.pyc' \
  --exclude='__pycache__'

# Also backup any custom scripts or configs from install directory
if [ -d "{{ superset_install_dir }}" ]; then
  tar -czf "${BACKUP_DIR}/superset_scripts_${TIMESTAMP}.tar.gz" \
    -C "{{ superset_install_dir | dirname }}" \
    "{{ superset_install_dir | basename }}" \
    --exclude='venv' \
    --exclude='*.db' \
    --exclude='*.log' \
    --exclude='__pycache__' \
    --exclude='*.pyc'
fi

echo "Configuration backup completed: ${BACKUP_FILE}"
echo "Scripts backup completed: ${BACKUP_DIR}/superset_scripts_${TIMESTAMP}.tar.gz"
