---
# Zero-downtime deployment tasks

- name: Create deployment script for zero-downtime reload
  ansible.builtin.template:
    src: zero-downtime-reload.sh.j2
    dest: /usr/local/bin/haproxy-zero-downtime-reload.sh
    owner: root
    group: root
    mode: "0755"
  when: haproxy_zero_downtime.enable | default(false)

- name: Test new configuration before deployment
  ansible.builtin.command:
    cmd: haproxy -c -f /etc/haproxy/haproxy.cfg.new
  register: config_test_result
  changed_when: false
  failed_when: config_test_result.rc != 0
  when:
    - haproxy_zero_downtime.enable | default(false)
    - ansible_check_mode == false

- name: Perform zero-downtime reload
  ansible.builtin.shell: |
    /usr/local/bin/haproxy-zero-downtime-reload.sh
  when:
    - haproxy_zero_downtime.enable | default(false)
    - config_test_result.rc == 0
    - ansible_check_mode == false
  notify: validate haproxy config
