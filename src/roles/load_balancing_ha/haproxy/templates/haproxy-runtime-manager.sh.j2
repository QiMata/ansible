#!/bin/bash
# HAProxy Runtime API Management Script
# Generated by Ansible

SOCKET_PATH="{{ haproxy_runtime_api.socket_path | default('/run/haproxy/admin.sock') }}"

# Function to check if socket exists
check_socket() {
    if [ ! -S "$SOCKET_PATH" ]; then
        echo "ERROR: HAProxy runtime socket not found at $SOCKET_PATH"
        exit 1
    fi
}

# Function to execute HAProxy runtime command
execute_command() {
    local cmd="$1"
    echo "$cmd" | socat stdio "$SOCKET_PATH"
}

# Main script logic
case "$1" in
    "stats")
        check_socket
        execute_command "show stat"
        ;;
    "info")
        check_socket
        execute_command "show info"
        ;;
    "enable")
        if [ -z "$2" ] || [ -z "$3" ]; then
            echo "Usage: $0 enable <backend> <server>"
            exit 1
        fi
        check_socket
        execute_command "enable server $2/$3"
        ;;
    "disable")
        if [ -z "$2" ] || [ -z "$3" ]; then
            echo "Usage: $0 disable <backend> <server>"
            exit 1
        fi
        check_socket
        execute_command "disable server $2/$3"
        ;;
    "weight")
        if [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ]; then
            echo "Usage: $0 weight <backend> <server> <weight>"
            exit 1
        fi
        check_socket
        execute_command "set weight $2/$3 $4"
        ;;
    "show-servers")
        if [ -z "$2" ]; then
            echo "Usage: $0 show-servers <backend>"
            exit 1
        fi
        check_socket
        execute_command "show servers state $2"
        ;;
    *)
        echo "Usage: $0 {stats|info|enable|disable|weight|show-servers}"
        echo ""
        echo "Examples:"
        echo "  $0 stats                           # Show HAProxy statistics"
        echo "  $0 info                            # Show HAProxy info"
        echo "  $0 enable backend1 server1         # Enable server1 in backend1"
        echo "  $0 disable backend1 server1        # Disable server1 in backend1"
        echo "  $0 weight backend1 server1 50      # Set weight of server1 to 50"
        echo "  $0 show-servers backend1           # Show servers in backend1"
        exit 1
        ;;
esac
