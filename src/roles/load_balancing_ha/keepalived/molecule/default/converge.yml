---
- name: Converge - Basic Configuration
  hosts: keepalived_cluster
  become: true
  roles:
    - role: keepalived

- name: Converge - Advanced Features Test
  hosts: ubuntu_test
  become: true
  vars:
    keepalived_vrrp_instances:
      - name: "VI_ADVANCED"
        state: "MASTER"
        interface: "eth0"
        virtual_router_id: 52
        priority: 200
        advert_int: 2
        preempt: false
        use_vmac: false
        unicast_src_ip: "172.20.0.12"
        unicast_peers:
          - "172.20.0.10"
          - "172.20.0.11"
        authentication:
          auth_type: "PASS"
          auth_pass: "advanced_test"
        virtual_ipaddresses:
          - ip: "172.20.0.200"
            cidr: 32
          - ip: "2001:db8::100"
            cidr: 128
        track_scripts:
          - "check_web_service"
        notify_master: "/etc/keepalived/scripts/notify_master.sh"
        notify_backup: "/etc/keepalived/scripts/notify_backup.sh"
    keepalived_vrrp_scripts:
      - name: "check_web_service"
        script: "/etc/keepalived/scripts/check_web.sh"
        interval: 3
        timeout: 2
        weight: -10
        fall: 2
        rise: 1
    keepalived_custom_scripts:
      - name: "check_web.sh"
        content: |
          #!/bin/bash
          # Simple web service check
          curl -f http://localhost:80/ >/dev/null 2>&1
        mode: "0755"
      - name: "notify_master.sh"
        content: |
          #!/bin/bash
          echo "$(date): Became MASTER" >> /var/log/keepalived_state.log
        mode: "0755"
      - name: "notify_backup.sh"
        content: |
          #!/bin/bash
          echo "$(date): Became BACKUP" >> /var/log/keepalived_state.log
        mode: "0755"
  roles:
    - role: keepalived
