#!/bin/bash
# Keepalived monitoring script
# Generated by Ansible - Do not edit manually

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
KEEPALIVED_PID=$(pgrep keepalived)

echo "[$TIMESTAMP] Keepalived Status Check"

if [ -n "$KEEPALIVED_PID" ]; then
    echo "[$TIMESTAMP] Keepalived is running (PID: $KEEPALIVED_PID)"
    
    # Check VRRP instance status
    if command -v ss >/dev/null 2>&1; then
        echo "[$TIMESTAMP] VRRP Multicast listeners:"
        ss -anu | grep 224.0.0.18 || echo "[$TIMESTAMP] No VRRP multicast listeners found"
    fi
    
    # Check virtual IPs
    echo "[$TIMESTAMP] Virtual IP addresses:"
    ip addr show | grep -E "inet.*secondary|inet6.*secondary" | while read line; do
        echo "[$TIMESTAMP] VIP: $line"
    done
    
    # Check keepalived stats if available
    if [ -S "{{ keepalived_snmp_socket }}" ]; then
        echo "[$TIMESTAMP] Keepalived SNMP socket available"
    fi
    
else
    echo "[$TIMESTAMP] ERROR: Keepalived is not running"
fi

echo "[$TIMESTAMP] ---"
