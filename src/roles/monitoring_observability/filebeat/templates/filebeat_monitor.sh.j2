#!/bin/bash
# Filebeat monitoring script
# Generated by Ansible - Do not edit manually

FILEBEAT_SERVICE="{{ filebeat_service_name }}"
FILEBEAT_CONFIG="{{ filebeat_config_file }}"
LOG_FILE="/var/log/filebeat_monitor.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Function to log messages
log_message() {
    echo "[$TIMESTAMP] $1" >> $LOG_FILE
}

# Check if Filebeat service is running
if ! systemctl is-active --quiet $FILEBEAT_SERVICE; then
    log_message "ERROR: Filebeat service is not running"
    systemctl status $FILEBEAT_SERVICE >> $LOG_FILE 2>&1
    exit 1
fi

# Test configuration
if ! filebeat test config -c $FILEBEAT_CONFIG >/dev/null 2>&1; then
    log_message "ERROR: Filebeat configuration test failed"
    filebeat test config -c $FILEBEAT_CONFIG >> $LOG_FILE 2>&1
    exit 1
fi

# Test output connectivity
if ! filebeat test output -c $FILEBEAT_CONFIG >/dev/null 2>&1; then
    log_message "WARNING: Filebeat output connectivity test failed"
    filebeat test output -c $FILEBEAT_CONFIG >> $LOG_FILE 2>&1
fi

{% if filebeat_http_enabled %}
# Check HTTP monitoring endpoint
if ! curl -s "http://{{ filebeat_http_host }}:{{ filebeat_http_port }}/stats" >/dev/null; then
    log_message "WARNING: Filebeat HTTP monitoring endpoint is not responding"
fi
{% endif %}

log_message "INFO: Filebeat monitoring check completed successfully"
