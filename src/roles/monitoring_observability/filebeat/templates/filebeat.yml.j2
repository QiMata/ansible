# ============================================================================
# Filebeat Configuration
# Generated by Ansible - Do not edit manually
# ============================================================================

# Global configuration
name: "{{ ansible_hostname }}"
{% if filebeat_global_tags %}
tags:
{% for key, value in filebeat_global_tags.items() %}
  - "{{ key }}:{{ value }}"
{% endfor %}
{% endif %}

{% if filebeat_global_fields %}
fields:
{% for key, value in filebeat_global_fields.items() %}
  {{ key }}: "{{ value }}"
{% endfor %}
fields_under_root: {{ filebeat_global_fields_under_root | lower }}
{% endif %}

# ============================================================================
# Inputs Configuration
# ============================================================================
filebeat.inputs:
{% for input in filebeat_inputs %}
- type: {{ input.type }}
  id: {{ input.id | default(input.type + '_' + loop.index0 | string) }}
  enabled: {{ input.enabled | default(true) | lower }}
{% if input.paths is defined %}
  paths:
{% for path in input.paths %}
    - "{{ path }}"
{% endfor %}
{% endif %}
{% if input.fields is defined %}
  fields:
{% for key, value in input.fields.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
  fields_under_root: {{ input.fields_under_root | default(false) | lower }}
{% endif %}
{% if input.multiline is defined %}
  multiline:
    pattern: '{{ input.multiline.pattern }}'
    negate: {{ input.multiline.negate | default(false) | lower }}
    match: {{ input.multiline.match | default('after') }}
{% if input.multiline.max_lines is defined %}
    max_lines: {{ input.multiline.max_lines }}
{% endif %}
{% if input.multiline.timeout is defined %}
    timeout: {{ input.multiline.timeout }}
{% endif %}
{% endif %}
{% if input.processors is defined %}
  processors:
{% for processor in input.processors %}
{% for key, value in processor.items() %}
    - {{ key }}:
{% if value is mapping %}
{% for k, v in value.items() %}
        {{ k }}: {{ v }}
{% endfor %}
{% else %}
        {{ value }}
{% endif %}
{% endfor %}
{% endfor %}
{% endif %}
{% if input.exclude_files is defined %}
  exclude_files:
{% for exclude in input.exclude_files %}
    - '{{ exclude }}'
{% endfor %}
{% endif %}
{% if input.include_lines is defined %}
  include_lines:
{% for include in input.include_lines %}
    - '{{ include }}'
{% endfor %}
{% endif %}
{% if input.exclude_lines is defined %}
  exclude_lines:
{% for exclude in input.exclude_lines %}
    - '{{ exclude }}'
{% endfor %}
{% endif %}
{% if input.harvester_buffer_size is defined %}
  harvester_buffer_size: {{ input.harvester_buffer_size }}
{% endif %}
{% if input.max_bytes is defined %}
  max_bytes: {{ input.max_bytes }}
{% endif %}
{% if input.containers is defined %}
  containers:
{% if input.containers.ids is defined %}
    ids:
{% for id in input.containers.ids %}
      - "{{ id }}"
{% endfor %}
{% endif %}
{% if input.containers.stream is defined %}
    stream: {{ input.containers.stream }}
{% endif %}
{% endif %}

{% endfor %}

{% if filebeat_additional_inputs %}
# Additional inputs
{% for input in filebeat_additional_inputs %}
{% if input.enabled | default(false) %}
- type: {{ input.type }}
  id: {{ input.id | default(input.type + '_additional_' + loop.index0 | string) }}
  enabled: {{ input.enabled | lower }}
{% if input.paths is defined %}
  paths:
{% for path in input.paths %}
    - "{{ path }}"
{% endfor %}
{% endif %}
{% if input.containers is defined %}
  containers:
{% if input.containers.ids is defined %}
    ids:
{% for id in input.containers.ids %}
      - "{{ id }}"
{% endfor %}
{% endif %}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

# ============================================================================
# Modules Configuration (if using modules)
# ============================================================================
filebeat.config.modules:
  path: {{ filebeat_modules_dir }}/*.yml
  reload.enabled: true
  reload.period: 10s

# ============================================================================
# Processors Configuration
# ============================================================================
{% if filebeat_global_processors or filebeat_processors %}
processors:
{% for processor in filebeat_global_processors + filebeat_processors %}
{% for key, value in processor.items() %}
- {{ key }}:
{% if value is mapping %}
{% for k, v in value.items() %}
    {{ k }}: {{ v }}
{% endfor %}
{% elif value is none %}
    ~
{% else %}
    {{ value }}
{% endif %}
{% endfor %}
{% endfor %}
{% endif %}

# ============================================================================
# Output Configuration
# ============================================================================
{% if filebeat_output_type == 'logstash' %}
output.logstash:
  hosts:
{% for host in filebeat_logstash_hosts %}
    - "{{ host }}"
{% endfor %}
  worker: {{ filebeat_logstash_worker }}
  compression_level: {{ filebeat_logstash_compression_level }}
  bulk_max_size: {{ filebeat_logstash_bulk_max_size }}
  timeout: {{ filebeat_logstash_timeout }}
  pipelining: {{ filebeat_logstash_pipelining }}
{% if filebeat_ssl_enabled %}
  ssl:
    enabled: true
{% if filebeat_ssl_certificate_authorities %}
    certificate_authorities:
{% for ca in filebeat_ssl_certificate_authorities %}
      - "{{ filebeat_config_dir }}/ca.crt"
{% endfor %}
{% endif %}
{% if filebeat_ssl_certificate %}
    certificate: "{{ filebeat_config_dir }}/filebeat.crt"
{% endif %}
{% if filebeat_ssl_key %}
    key: "{{ filebeat_config_dir }}/filebeat.key"
{% endif %}
    verification_mode: {{ filebeat_ssl_verification_mode }}
{% endif %}

{% elif filebeat_output_type == 'elasticsearch' %}
output.elasticsearch:
  hosts:
{% for host in filebeat_elasticsearch_hosts %}
    - "{{ host }}"
{% endfor %}
{% if filebeat_elasticsearch_username %}
  username: "{{ filebeat_elasticsearch_username }}"
{% endif %}
{% if filebeat_elasticsearch_password %}
  password: "{{ filebeat_elasticsearch_password }}"
{% endif %}
{% if filebeat_api_key_enabled %}
  api_key: "{{ filebeat_api_key_id }}:{{ filebeat_api_key_value }}"
{% endif %}
  index: "{{ filebeat_elasticsearch_index }}"
  template:
    enabled: {{ filebeat_elasticsearch_template_enabled | lower }}
{% if filebeat_ssl_enabled %}
  ssl:
    enabled: true
{% if filebeat_ssl_certificate_authorities %}
    certificate_authorities:
{% for ca in filebeat_ssl_certificate_authorities %}
      - "{{ filebeat_config_dir }}/ca.crt"
{% endfor %}
{% endif %}
{% if filebeat_ssl_certificate %}
    certificate: "{{ filebeat_config_dir }}/filebeat.crt"
{% endif %}
{% if filebeat_ssl_key %}
    key: "{{ filebeat_config_dir }}/filebeat.key"
{% endif %}
    verification_mode: {{ filebeat_ssl_verification_mode }}
{% endif %}

{% elif filebeat_output_type == 'kafka' %}
output.kafka:
  hosts:
{% for host in filebeat_kafka_hosts %}
    - "{{ host }}"
{% endfor %}
  topic: "{{ filebeat_kafka_topic }}"
  partition.round_robin:
    reachable_only: {{ filebeat_kafka_partition_round_robin.reachable_only | lower }}

{% elif filebeat_output_type == 'file' %}
output.file:
  path: "{{ filebeat_file_path }}"
  filename: "{{ filebeat_file_filename }}"
  rotate_every_kb: {{ filebeat_file_rotate_every_kb }}
  number_of_files: {{ filebeat_file_number_of_files }}

{% elif filebeat_output_type == 'console' %}
output.console:
  pretty: true

{% endif %}

# ============================================================================
# Queue Configuration
# ============================================================================
queue.mem:
  events: {{ filebeat_queue_mem_events }}
  flush.min_events: {{ filebeat_queue_mem_flush_min_events }}
  flush.timeout: {{ filebeat_queue_mem_flush_timeout }}

# ============================================================================
# General Configuration
# ============================================================================
max_procs: {{ filebeat_max_procs }}

# Publisher settings
output.elasticsearch.worker: 1
{% if filebeat_publisher_pipeline_disable_host %}
output.elasticsearch.pipeline: ""
{% endif %}

# ============================================================================
# Logging Configuration
# ============================================================================
logging.level: {{ filebeat_logging_level }}
{% if filebeat_logging_to_files %}
logging.to_files: true
logging.files:
  path: {{ filebeat_logging_files_path }}
  name: {{ filebeat_logging_files_name }}
  keepfiles: {{ filebeat_logging_files_keepfiles }}
  rotateeverybytes: {{ filebeat_logging_files_rotateeverybytes }}
{% endif %}

# ============================================================================
# Monitoring Configuration
# ============================================================================
{% if filebeat_monitoring_enabled %}
monitoring:
  enabled: true
{% if filebeat_monitoring_elasticsearch_hosts %}
  elasticsearch:
    hosts:
{% for host in filebeat_monitoring_elasticsearch_hosts %}
      - "{{ host }}"
{% endfor %}
{% if filebeat_monitoring_elasticsearch_username %}
    username: "{{ filebeat_monitoring_elasticsearch_username }}"
{% endif %}
{% if filebeat_monitoring_elasticsearch_password %}
    password: "{{ filebeat_monitoring_elasticsearch_password }}"
{% endif %}
{% endif %}
{% endif %}

{% if filebeat_http_enabled %}
# HTTP endpoint for monitoring
http:
  enabled: {{ filebeat_http_enabled | lower }}
  host: "{{ filebeat_http_host }}"
  port: {{ filebeat_http_port }}
{% endif %}

# ============================================================================
# Custom Configuration
# ============================================================================
{% if filebeat_custom_config %}
{% for key, value in filebeat_custom_config.items() %}
{{ key }}: {{ value }}
{% endfor %}
{% endif %}
