# Grafana Configuration File
# Generated by Ansible

[server]
http_port = {{ grafana_http_port }}
protocol = {{ grafana_protocol }}
domain = {{ grafana_domain }}
{% if grafana_root_url %}
root_url = {{ grafana_root_url }}
{% else %}
root_url = %(protocol)s://%(domain)s:%(http_port)s/
{% endif %}
{% if grafana_https_enabled %}
cert_file = {{ grafana_cert_file }}
cert_key = {{ grafana_cert_key }}
{% endif %}

[database]
type = {{ grafana_database.type }}
{% if grafana_database.host %}
host = {{ grafana_database.host }}
{% endif %}
name = {{ grafana_database.name }}
user = {{ grafana_database.user }}
password = {{ grafana_database.password }}
{% if grafana_database.ssl_mode %}
ssl_mode = {{ grafana_database.ssl_mode }}
{% endif %}
{% if grafana_database.ca_cert_path %}
ca_cert_path = {{ grafana_database.ca_cert_path }}
{% endif %}
{% if grafana_database.client_cert_path %}
client_cert_path = {{ grafana_database.client_cert_path }}
{% endif %}
{% if grafana_database.client_key_path %}
client_key_path = {{ grafana_database.client_key_path }}
{% endif %}
max_idle_conn = {{ grafana_database.max_idle_conn }}
max_open_conn = {{ grafana_database.max_open_conn }}
conn_max_lifetime = {{ grafana_database.conn_max_lifetime }}

[security]
admin_user = {{ grafana_admin_user }}
admin_password = {{ grafana_admin_password }}
{% if grafana_security_enabled %}
{% if grafana_security_headers.strict_transport_security %}
strict_transport_security = true
strict_transport_security_max_age_seconds = {{ grafana_security_headers.strict_transport_security_max_age_seconds }}
strict_transport_security_preload = {{ grafana_security_headers.strict_transport_security_preload | lower }}
strict_transport_security_subdomains = {{ grafana_security_headers.strict_transport_security_subdomains | lower }}
{% endif %}
{% if grafana_security_headers.x_content_type_options %}
x_content_type_options = true
{% endif %}
{% if grafana_security_headers.x_xss_protection %}
x_xss_protection = true
{% endif %}
x_frame_options = {{ grafana_security_headers.x_frame_options }}
{% if grafana_security_headers.content_security_policy %}
content_security_policy = true
{% if grafana_security_headers.content_security_policy_template %}
content_security_policy_template = {{ grafana_security_headers.content_security_policy_template }}
{% endif %}
{% endif %}
{% endif %}

{% if grafana_cors_enabled %}
[cors]
allow_origin = {{ grafana_cors_allow_origin }}
allow_credentials = {{ grafana_cors_allow_credentials | lower }}
{% endif %}

[session]
provider = {{ grafana_session_provider }}
{% if grafana_session_provider_config %}
provider_config = {{ grafana_session_provider_config }}
{% endif %}
cookie_name = {{ grafana_session_cookie_name }}
cookie_secure = {{ grafana_session_cookie_secure | lower }}
session_life_time = {{ grafana_session_session_life_time }}

[auth.ldap]
enabled = {{ grafana_ldap_enabled | lower }}
{% if grafana_ldap_enabled %}
config_file = {{ grafana_ldap_file }}
allow_sign_up = true
{% endif %}

{% if grafana_oauth_enabled %}
[auth]
oauth_auto_login = {{ grafana_oauth_auto_login | lower }}

{% for provider, config in grafana_oauth_providers.items() %}
{% if config.enabled %}
[auth.{{ provider }}]
enabled = true
client_id = {{ config.client_id }}
client_secret = {{ config.client_secret }}
scopes = {{ config.scopes }}
auth_url = {{ config.auth_url }}
token_url = {{ config.token_url }}
api_url = {{ config.api_url }}
allow_sign_up = {{ config.allow_sign_up | default(true) | lower }}
{% if config.role_attribute_path is defined %}
role_attribute_path = {{ config.role_attribute_path }}
{% endif %}
{% if provider == 'github' %}
{% if config.team_ids is defined %}
team_ids = {{ config.team_ids }}
{% endif %}
{% if config.allowed_organizations is defined %}
allowed_organizations = {{ config.allowed_organizations }}
{% endif %}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{% if grafana_performance_enabled %}
[query_history]
max_query_history_per_user = 100

[query]
max_concurrent_queries = {{ grafana_performance_config.max_concurrent_user_queries }}
max_concurrent_dashboard_queries = {{ grafana_performance_config.max_concurrent_dashboard_queries }}
timeout = {{ grafana_performance_config.query_timeout }}
max_query_length = {{ grafana_performance_config.max_query_length }}
max_series_per_dashboard = {{ grafana_performance_config.max_series_per_dashboard }}
max_annotations_to_fetch = {{ grafana_performance_config.max_annotations_to_fetch }}
max_tag_values_per_tag = {{ grafana_performance_config.max_tag_values_per_tag }}
{% endif %}

{% if grafana_caching_enabled %}
[caching]
type = {{ grafana_caching_config.type }}
ttl = {{ grafana_caching_config.ttl }}
{% if grafana_caching_config.type == 'redis' %}
[caching.redis]
address = {{ grafana_caching_config.redis.address }}
{% if grafana_caching_config.redis.password %}
password = {{ grafana_caching_config.redis.password }}
{% endif %}
db = {{ grafana_caching_config.redis.db }}
{% elif grafana_caching_config.type == 'memcached' %}
[caching.memcached]
servers = {{ grafana_caching_config.memcached.servers }}
{% endif %}
{% endif %}

{% if grafana_monitoring_enabled %}
[metrics]
enabled = {{ grafana_monitoring_config.metrics_enabled | lower }}
{% if grafana_monitoring_config.metrics_basic_auth_username %}
basic_auth_username = {{ grafana_monitoring_config.metrics_basic_auth_username }}
basic_auth_password = {{ grafana_monitoring_config.metrics_basic_auth_password }}
{% endif %}

[tracing.jaeger]
{% if grafana_monitoring_config.tracing_enabled %}
address = {{ grafana_monitoring_config.tracing_jaeger_address }}
{% endif %}

[log]
level = {{ grafana_monitoring_config.logging_level }}
{% if grafana_monitoring_config.log_queries %}
filters = sqlstore:debug
{% endif %}
{% if grafana_monitoring_config.log_request_at_debug_level %}
[log.console]
level = debug
format = console
{% endif %}
{% else %}
[metrics]
enabled = true
{% endif %}

{% if grafana_alerting_enabled %}
[alerting]
enabled = true
execute_alerts = true
{% else %}
[alerting]
enabled = false
{% endif %}

{% if grafana_lb_enabled and grafana_lb_health_check_enabled %}
[server]
enable_gzip = true
{% endif %}
