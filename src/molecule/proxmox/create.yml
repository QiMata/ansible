---
- name: Create Proxmox LXC container
  hosts: localhost
  gather_facts: false
  vars:
    proxmox_host: "{{ lookup('env', 'PROXMOX_HOST') | default('192.168.1.100') }}"
    proxmox_user: "{{ lookup('env', 'PROXMOX_USER') | default('root@pam') }}"
    proxmox_password: "{{ lookup('env', 'PROXMOX_PASSWORD') }}"
    proxmox_node: "{{ lookup('env', 'PROXMOX_NODE') | default('pve') }}"
    container_id: "{{ lookup('env', 'CONTAINER_ID') | default('999') }}"
    container_name: "debian-test-instance"
    template: "{{ lookup('env', 'TEMPLATE') | default('debian-12-standard_12.2-1_amd64.tar.zst') }}"
    storage: "{{ lookup('env', 'STORAGE') | default('local-lvm') }}"
    memory: "{{ lookup('env', 'MEMORY') | default('1024') }}"
    cores: "{{ lookup('env', 'CORES') | default('2') }}"
  tasks:
    - name: Create LXC container
      uri:
        url: "https://{{ proxmox_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc"
        method: POST
        user: "{{ proxmox_user }}"
        password: "{{ proxmox_password }}"
        validate_certs: false
        body_format: form-urlencoded
        body:
          vmid: "{{ container_id }}"
          hostname: "{{ container_name }}"
          ostemplate: "local:vztmpl/{{ template }}"
          memory: "{{ memory }}"
          cores: "{{ cores }}"
          net0: "name=eth0,bridge=vmbr0,ip=dhcp"
          storage: "{{ storage }}"
          unprivileged: "1"
          start: "1"
      register: create_result

    - name: Wait for container to start
      pause:
        seconds: 30

    - name: Add container to inventory
      add_host:
        name: "{{ container_name }}"
        groups: 
          - debian
          - test_instances
        ansible_user: root
        ansible_connection: ssh
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
